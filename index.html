<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ¨åŠ›æ€»æˆå°æ¶è¯•éªŒæ•°æ®åˆ†æå¹³å°</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* å·¦ä¾§æ ï¼šåˆ—ååˆ—è¡¨ */
        .sidebar {
            width: 300px;
            background: white;
            border-right: 2px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom: 2px solid #667eea;
        }

        .sidebar-header h2 {
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .file-selector {
            margin-top: 10px;
        }

        .file-selector select {
            width: 100%;
            padding: 8px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 5px;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 0.9em;
        }

        .file-selector select option {
            background: #667eea;
            color: white;
        }

        .column-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .column-item {
            padding: 12px 15px;
            margin: 5px 0;
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .column-item:hover {
            background: #e9ecef;
            border-color: #667eea;
            transform: translateX(5px);
        }

        .column-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            font-weight: 600;
        }

        .column-item.selected {
            background: #e3f2fd;
            border-color: #2196f3;
            color: #1976d2;
        }

        .column-item.active.selected {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
        }

        /* å³ä¾§ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #f5f7fa;
        }

        .content-header {
            padding: 20px 30px;
            background: white;
            border-bottom: 2px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .content-header h2 {
            color: #667eea;
            font-size: 1.5em;
            margin: 0;
            font-weight: 700;
        }

        .content-body {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            background: #f5f7fa;
        }

        /* æ•°æ®åˆ†æåŒºåŸŸ */
        .analysis-section {
            margin-bottom: 30px;
        }

        .analysis-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .stat-card .label {
            font-size: 0.85em;
            opacity: 0.9;
            margin-bottom: 6px;
        }

        .stat-card .value {
            font-size: 1.5em;
            font-weight: bold;
        }

        /* å›¾è¡¨åŒºåŸŸ */
        .chart-section {
            margin-top: 30px;
        }

        .charts-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .chart-container {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.08);
            position: relative;
            transition: box-shadow 0.3s;
        }

        .chart-container:hover {
            box-shadow: 0 5px 20px rgba(0,0,0,0.12);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            padding: 15px 20px;
            border-radius: 8px;
            margin: -20px -20px 20px -20px;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        .chart-header h4 {
            color: #667eea;
            font-size: 1.2em;
            font-weight: 700;
            margin: 0;
        }

        .chart-close {
            background: #f0f0f0;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            color: #666;
            transition: all 0.3s;
        }

        .chart-close:hover {
            background: #e0e0e0;
            color: #c33;
        }

        /* å›¾è¡¨æ§åˆ¶é¢æ¿æ ·å¼ */
        .chart-controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        /* åˆ†ç»„æ ·å¼ */
        .control-group {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .control-group:hover {
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            border-color: #dee2e6;
        }

        /* åˆ†ç»„æ ‡é¢˜ */
        .group-title {
            margin: 0 0 15px 0;
            font-size: 16px;
            font-weight: 700;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* åæ ‡è½´ç»„ */
        .axis-group {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 12px;
            margin-right: 15px;
            margin-bottom: 10px;
            border: 1px solid #e9ecef;
            min-width: 300px;
        }

        /* åæ ‡è½´æ ‡é¢˜ */
        .axis-title {
            margin: 0 0 8px 0;
            font-size: 14px;
            font-weight: 600;
            color: #6c757d;
        }

        .chart-controls-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-start;
        }

        .axis-control-group {
            display: flex;
            align-items: center;
        }

        .axis-control {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .axis-control label {
            font-size: 14px;
            font-weight: 600;
            color: #555;
            min-width: 60px;
            white-space: nowrap;
        }

        .axis-input {
            width: 110px;
            padding: 9px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            transition: all 0.3s ease;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.075);
        }

        .axis-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
            transform: translateY(-1px);
        }

        .axis-separator {
            color: #666;
            font-weight: bold;
            margin: 0 4px;
        }

        /* åº”ç”¨æŒ‰é’®æ ·å¼ */
        .axis-button {
            padding: 9px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }

        .axis-button:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a4099 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
        }

        .axis-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }

        /* é‡ç½®æŒ‰é’®æ ·å¼ */
        .reset-button {
            padding: 9px 16px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #495057;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 5px;
        }

        .reset-button:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            border-color: #ced4da;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .reset-button:active {
            transform: translateY(0);
            box-shadow: none;
        }

        .axis-select-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .axis-select-group label {
            font-size: 14px;
            font-weight: 600;
            color: #555;
        }

        .axis-select {
            padding: 9px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.075);
        }

        .axis-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
            transform: translateY(-1px);
        }

        .chart-wrapper {
            position: relative;
            width: 100%;
        }

        .chart-canvas {
            width: 100%;
            height: 500px;
            display: block;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2em;
        }

        .error {
            padding: 20px;
            background: #fee;
            color: #c33;
            border-radius: 5px;
            margin: 20px 0;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§æ ï¼šåˆ—ååˆ—è¡¨ -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>ğŸ“Š æ•°æ®åˆ—å</h2>
                <div class="file-selector">
                    <input type="file" id="fileInput" accept=".dat,.csv,.txt,.xlsx" style="display: none;" onchange="handleFileSelect(event)">
                    <button onclick="document.getElementById('fileInput').click()" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 5px; color: white; cursor: pointer; font-size: 0.9em;">
                        é€‰æ‹©æ–‡ä»¶
                    </button>
                    <div id="fileName" style="margin-top: 10px; font-size: 0.85em; opacity: 0.9;"></div>
                    <!-- æ–‡ä»¶åŠ è½½è¿›åº¦æ¡ -->
                    <div id="fileLoadingProgress" style="margin-top: 10px; display: none;">
                        <div id="fileLoadingMessage" style="font-size: 0.85em; opacity: 0.9; margin-bottom: 5px;">åŠ è½½ä¸­...</div>
                        <div style="width: 100%; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; overflow: hidden;">
                            <div id="fileLoadingBar" style="width: 0%; height: 100%; background: linear-gradient(135deg, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0.4) 100%); border-radius: 3px; transition: width 0.3s ease;"></div>
                        </div>
                        <div id="fileLoadingText" style="margin-top: 5px; font-size: 0.75em; opacity: 0.8;">0%</div>
                    </div>
                    <!-- åˆ—åè¡Œå·è®¾ç½® -->
                        <div style="margin-top: 15px;">
                            <label style="font-size: 0.85em; opacity: 0.9; margin-right: 5px;">åˆ—åè¡Œå·:</label>
                            <input type="number" id="headerRowInput" value="1" min="1" style="width: 60px; padding: 5px; border: 1px solid rgba(255,255,255,0.3); border-radius: 3px; background: rgba(255,255,255,0.2); color: white; font-size: 0.85em;">
                            <button onclick="reloadFileData()" style="margin-left: 5px; padding: 5px 10px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 3px; color: white; cursor: pointer; font-size: 0.85em;">
                                åº”ç”¨
                            </button>
                        </div>
                </div>
            </div>
            <!-- æœç´¢æ¡† -->
            <div style="padding: 10px; background: white;">
                <input type="text" id="columnSearchInput" placeholder="æœç´¢åˆ—å..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: #f8f9fa; color: #333; font-size: 0.9em; outline: none; cursor: text; box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);">
            </div>
            <div class="column-list" id="columnList">
                <div class="empty-state">
                    <h3>è¯·é€‰æ‹©æ–‡ä»¶</h3>
                    <p>é€‰æ‹©æ–‡ä»¶åï¼Œåˆ—åå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <div class="content-header">
                <h2 id="selectedColumnName">è¯·ä»å·¦ä¾§é€‰æ‹©è¦åˆ†æçš„åˆ—</h2>
            </div>
            <div class="content-body" id="contentBody">
                <div class="empty-state">
                    <h3>ğŸ‘ˆ é€‰æ‹©æ•°æ®åˆ—</h3>
                    <p>ä»å·¦ä¾§åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªåˆ—åï¼ŒæŸ¥çœ‹è¯¥åˆ—çš„æ•°æ®åˆ†æå’Œå¯è§†åŒ–å›¾è¡¨</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let parsedData = null;
        let columnNames = [];
        let currentSelectedColumn = null;
        let chartCounter = 0;
        let activeCharts = []; // å­˜å‚¨æ´»åŠ¨çš„å›¾è¡¨ä¿¡æ¯

        // é¢„è®¾é¢œè‰²åˆ—è¡¨ï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„æ•°æ®çº¿
        const lineColors = [
            '#0066cc', '#ff6600', '#009900', '#cc0066', '#6600cc',
            '#00cccc', '#ffcc00', '#cc6600', '#990099', '#006666'
        ];

        let currentFile = null;

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            currentFile = file;
            document.getElementById('fileName').textContent = file.name;
            
            // æ˜¾ç¤ºåŠ è½½è¿›åº¦æ¡
            showLoadingProgress('æ­£åœ¨åŠ è½½æ–‡ä»¶...');

            loadFile(file);
        }

        // é‡æ–°åŠ è½½æ–‡ä»¶æ•°æ®ï¼ˆå½“ç”¨æˆ·ä¿®æ”¹åˆ—åè¡Œå·æ—¶ï¼‰
        function reloadFileData() {
            if (!currentFile) {
                alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
                return;
            }
            // æ˜¾ç¤ºåŠ è½½è¿›åº¦æ¡
            showLoadingProgress('æ­£åœ¨é‡æ–°åŠ è½½æ–‡ä»¶...');
            loadFile(currentFile);
        }

        // åŠ è½½æ–‡ä»¶
        function loadFile(file) {
            if (file.name.endsWith('.xlsx')) {
                // å¤„ç†.xlsxæ–‡ä»¶
                const reader = new FileReader();
                reader.onload = (e) => {
                    loadXlsxData(e.target.result, file.name);
                };
                reader.onerror = () => {
                    const columnList = document.getElementById('columnList');
                    columnList.innerHTML = '<div class="error">Excelæ–‡ä»¶è¯»å–å¤±è´¥</div>';
                };
                reader.readAsArrayBuffer(file);
            } else {
                // å¤„ç†æ–‡æœ¬æ–‡ä»¶ï¼ˆ.dat, .csv, .txtï¼‰
                const reader = new FileReader();
                reader.onload = (e) => {
                    loadFileData(e.target.result, file.name);
                };
                reader.onerror = () => {
                    const columnList = document.getElementById('columnList');
                    columnList.innerHTML = '<div class="error">æ–‡ä»¶è¯»å–å¤±è´¥</div>';
                };
                reader.readAsText(file, 'GBK'); // å°è¯•GBKç¼–ç 
            }
        }

        // åŠ è½½æ–‡æœ¬æ–‡ä»¶æ•°æ®
        function loadFileData(rawData, fileName) {
            const columnList = document.getElementById('columnList');
            columnList.innerHTML = '<div class="loading">æ­£åœ¨è§£ææ–‡ä»¶...<br><div id="parseProgress" style="margin-top: 10px; font-size: 14px; color: #666;">å‡†å¤‡è§£æ...</div></div>';

            // æ›´æ–°å³ä¾§åŠ è½½è¿›åº¦
            updateLoadingProgress(10, 'æ­£åœ¨è§£ææ–‡ä»¶...');

            // ä½¿ç”¨setTimeoutå°†è§£æä»»åŠ¡æ”¾å…¥äº‹ä»¶é˜Ÿåˆ—ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹
            setTimeout(() => {
                try {
                    // ä½¿ç”¨æ›´é«˜æ•ˆçš„æ–¹å¼å¤„ç†æ–‡ä»¶è§£æ
                    const parseProgress = document.getElementById('parseProgress');
                    
                    // è·å–ç”¨æˆ·æŒ‡å®šçš„åˆ—åè¡Œå·ï¼ˆè½¬æ¢ä¸º0-basedç´¢å¼•ï¼‰
                    const headerRow = parseInt(document.getElementById('headerRowInput').value) || 1;
                    const headerIndex = headerRow - 1;
                    
                    // 1. å°†æ•°æ®æŒ‰è¡Œåˆ†å‰²
                    const lines = rawData.split('\n').filter(line => line.trim());
                    
                    if (lines.length < headerRow + 1) {
                        throw new Error(`æ–‡ä»¶è¡Œæ•°ä¸è¶³ï¼Œæ— æ³•è·å–ç¬¬${headerRow}è¡Œçš„åˆ—å`);
                    }
                    
                    // 2. ä»æŒ‡å®šè¡Œè§£æåˆ—å
                    const headerLine = lines[headerIndex].trim();
                    
                    // åˆ†å‰²åˆ—åï¼Œä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åˆ†å‰²ï¼Œä¿ç•™ç©ºå€¼
                    // \s+ åŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªç©ºç™½å­—ç¬¦
                    let allColumnNames = headerLine.split(/(\s+)/).filter((val, index) => {
                        // åªä¿ç•™å¶æ•°ç´¢å¼•çš„å…ƒç´ ï¼Œå› ä¸ºå¥‡æ•°ç´¢å¼•æ˜¯ç©ºç™½å­—ç¬¦
                        return index % 2 === 0;
                    });
                    
                    // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœç¬¬ä¸€åˆ—æ˜¯'1'ï¼Œä¸”åé¢æœ‰è¿ç»­çš„ç©ºåˆ—ï¼Œç¡®ä¿ä¿ç•™å®ƒä»¬
                    // æ£€æŸ¥å‰5åˆ—ï¼Œç¡®ä¿æ­£ç¡®å¤„ç†è¿ç»­ç©ºæ ¼
                    const processedColumnNames = [];
                    let hasNonEmptyCol = false;
                    
                    // å…ˆå°†åŸå§‹åˆ—åæŒ‰\tåˆ†å‰²ï¼Œç¡®ä¿å¤„ç†åˆ¶è¡¨ç¬¦
                    const tabSplit = headerLine.split('\t');
                    if (tabSplit.length > 1) {
                        allColumnNames = tabSplit;
                    } else {
                        // å¦‚æœä¸æ˜¯åˆ¶è¡¨ç¬¦åˆ†éš”ï¼Œä½¿ç”¨æ›´ç²¾ç¡®çš„ç©ºæ ¼åˆ†å‰²
                        allColumnNames = [];
                        let lastPos = 0;
                        let i = 0;
                        
                        while (i < headerLine.length) {
                            // æ‰¾åˆ°ä¸‹ä¸€ä¸ªéç©ºæ ¼å­—ç¬¦
                            while (i < headerLine.length && (headerLine[i] === ' ' || headerLine[i] === '\t')) {
                                i++;
                            }
                            
                            if (i < headerLine.length) {
                                // æ‰¾åˆ°ä¸‹ä¸€ä¸ªç©ºæ ¼å­—ç¬¦
                                const nextSpace = headerLine.indexOf(' ', i);
                                const nextTab = headerLine.indexOf('\t', i);
                                let nextDelimiter = -1;
                                
                                if (nextSpace !== -1 && nextTab !== -1) {
                                    nextDelimiter = Math.min(nextSpace, nextTab);
                                } else if (nextSpace !== -1) {
                                    nextDelimiter = nextSpace;
                                } else if (nextTab !== -1) {
                                    nextDelimiter = nextTab;
                                } else {
                                    nextDelimiter = headerLine.length;
                                }
                                
                                const colName = headerLine.substring(i, nextDelimiter).trim();
                                
                                // è®¡ç®—å½“å‰åˆ—å’Œä¸Šä¸€åˆ—ä¹‹é—´çš„ç©ºæ ¼æ•°ï¼Œç¡®å®šæ˜¯å¦éœ€è¦æ·»åŠ ç©ºåˆ—
                                if (i > lastPos + 1) {
                                    // å¦‚æœä¸¤ä¸ªåˆ—åä¹‹é—´æœ‰å¤šä¸ªç©ºæ ¼ï¼Œæ·»åŠ ç©ºåˆ—
                                    const spacesBetween = i - lastPos;
                                    const emptyCols = Math.floor(spacesBetween / 2); // æ¯ä¸¤ä¸ªç©ºæ ¼ä»£è¡¨ä¸€ä¸ªç©ºåˆ—
                                    for (let j = 0; j < emptyCols; j++) {
                                        processedColumnNames.push('');
                                    }
                                }
                                
                                processedColumnNames.push(colName);
                                lastPos = nextDelimiter;
                                i = nextDelimiter + 1;
                            } else {
                                break;
                            }
                        }
                        
                        allColumnNames = processedColumnNames;
                    }
                    
                    console.log('è§£æåˆ°çš„æ‰€æœ‰åˆ—å:', allColumnNames);
                    
                    // 3. è·³è¿‡å‰4åˆ—ï¼Œä»ç¬¬5åˆ—å¼€å§‹ä½¿ç”¨åˆ—å
                    // å‰4åˆ—æ˜¯ï¼š'1', '', '', '', 'Alias', 'Date', 'Time', ...
                    const skipColumns = 4;
                    columnNames = allColumnNames.slice(skipColumns);
                    
                    // è¿‡æ»¤æ‰ç©ºåˆ—å
                    columnNames = columnNames.filter(col => col.trim() !== '');
                    
                    if (columnNames.length === 0) {
                        throw new Error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„åˆ—å');
                    }
                    
                    // 4. è§£ææ•°æ®è¡Œ
                    parsedData = [];
                    const totalLines = lines.length;
                    let processedLines = 0;
                    let lastProgressUpdate = 0;
                    
                    // ä»ç¬¬21è¡Œå¼€å§‹è§£ææ•°æ®ï¼ˆå‰é¢20è¡Œæ˜¯è¡¨å¤´å’Œå…¶ä»–ä¿¡æ¯ï¼‰
                    for (let lineIndex = 20; lineIndex < lines.length; lineIndex++) {
                        const line = lines[lineIndex].trim();
                        if (!line || line.length < 5) {
                            processedLines++;
                            continue;
                        }
                        
                        // åˆ†å‰²å­—æ®µ
                        const values = line.split(/\s+/).filter(val => val.trim());
                        
                        if (values.length >= allColumnNames.length * 0.8) {
                            const row = {};
                            let hasValidData = false;
                            
                            // ä»ç¬¬5åˆ—å¼€å§‹å¤„ç†ï¼ˆè·³è¿‡å‰4åˆ—ï¼‰
                            columnNames.forEach((col, idx) => {
                                const dataIndex = idx + skipColumns; // è·³è¿‡å‰4åˆ—
                                if (dataIndex < values.length) {
                                    const val = values[dataIndex];
                                    const numVal = parseFloat(val);
                                    if (!isNaN(numVal)) {
                                        row[col] = numVal;
                                        hasValidData = true;
                                    } else {
                                        row[col] = val || null;
                                    }
                                } else {
                                    row[col] = null;
                                }
                            });
                            
                            if (hasValidData) {
                                parsedData.push(row);
                            }
                        }
                        
                        processedLines++;
                        
                        // æ›´æ–°è¿›åº¦ï¼ˆæ¯å¤„ç†1000è¡Œæ›´æ–°ä¸€æ¬¡ï¼Œé¿å…é¢‘ç¹DOMæ“ä½œï¼‰
                    const dataLines = totalLines - 20;
                    if (processedLines % 1000 === 0 || processedLines === dataLines) {
                        const progress = Math.round((processedLines / dataLines) * 100);
                        if (progress > lastProgressUpdate) {
                            parseProgress.textContent = `æ­£åœ¨è§£ææ•°æ®... ${progress}% (${processedLines}/${dataLines}è¡Œ)`;
                            // æ›´æ–°å³ä¾§åŠ è½½è¿›åº¦ï¼Œç¡®ä¿åœ¨æœ€åä¸€æ¬¡æ›´æ–°æ—¶è¿›åº¦ä¸º100%
                            const overallProgress = processedLines === dataLines ? 100 : 10 + Math.round(progress * 0.8);
                            updateLoadingProgress(overallProgress, `æ­£åœ¨è§£ææ•°æ®... ${progress}%`);
                            lastProgressUpdate = progress;
                        }
                    }
                    }

                    // æ›´æ–°è¿›åº¦åˆ°100%
                    updateLoadingProgress(100, 'æ–‡ä»¶åŠ è½½å®Œæˆ');
                    
                    // æ˜¾ç¤ºåˆ—ååˆ—è¡¨
                    displayColumnList();
                    
                    // æ–‡ä»¶åŠ è½½å®Œæˆï¼Œéšè—è¿›åº¦æ¡
                    const contentBody = document.getElementById('contentBody');
                    if (contentBody) {
                        // ç¡®ä¿æ˜¾ç¤ºåˆ—ååˆ—è¡¨åï¼Œå³ä¾§å†…å®¹åŒºæ¢å¤æ­£å¸¸
                        contentBody.innerHTML = `
                            <div class="empty-state">
                                <h3>ğŸ‘ˆ é€‰æ‹©æ•°æ®åˆ—</h3>
                                <p>ä»å·¦ä¾§åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªåˆ—åï¼ŒæŸ¥çœ‹è¯¥åˆ—çš„æ•°æ®åˆ†æå’Œå¯è§†åŒ–å›¾è¡¨</p>
                            </div>
                        `;
                    }

                    console.log('æ–‡ä»¶åŠ è½½æˆåŠŸ:', {
                        æ–‡ä»¶å: fileName,
                        åˆ—æ•°: columnNames.length,
                        æ•°æ®è¡Œæ•°: parsedData.length,
                        æ€»å¤„ç†è¡Œæ•°: processedLines
                    });

                } catch (error) {
                    console.error('åŠ è½½æ–‡ä»¶å¤±è´¥:', error);
                    columnList.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
                    // éšè—å·¦ä¾§æ–‡ä»¶é€‰æ‹©åŒºåŸŸçš„è¿›åº¦æ¡
                    const fileLoadingProgress = document.getElementById('fileLoadingProgress');
                    if (fileLoadingProgress) {
                        fileLoadingProgress.style.display = 'none';
                    }
                }
            }, 0);
        }

        // åŠ è½½Excelæ–‡ä»¶æ•°æ®
        function loadXlsxData(arrayBuffer, fileName) {
            const columnList = document.getElementById('columnList');
            columnList.innerHTML = '<div class="loading">æ­£åœ¨è§£æExcelæ–‡ä»¶...<br><div id="parseProgress" style="margin-top: 10px; font-size: 14px; color: #666;">å‡†å¤‡è§£æ...</div></div>';

            // æ›´æ–°å³ä¾§åŠ è½½è¿›åº¦
            updateLoadingProgress(10, 'æ­£åœ¨è§£æExcelæ–‡ä»¶...');

            // ä½¿ç”¨setTimeoutå°†è§£æä»»åŠ¡æ”¾å…¥äº‹ä»¶é˜Ÿåˆ—ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹
            setTimeout(() => {
                try {
                    const parseProgress = document.getElementById('parseProgress');
                    
                    // ä½¿ç”¨XLSXåº“è§£æExcelæ–‡ä»¶
                    parseProgress.textContent = 'æ­£åœ¨è¯»å–Excelæ–‡ä»¶...';
                    updateLoadingProgress(20, 'æ­£åœ¨è¯»å–Excelæ–‡ä»¶...');
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                    
                    // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // è½¬æ¢ä¸ºJSONæ ¼å¼
                    parseProgress.textContent = 'æ­£åœ¨è½¬æ¢æ•°æ®æ ¼å¼...';
                    updateLoadingProgress(30, 'æ­£åœ¨è½¬æ¢æ•°æ®æ ¼å¼...');
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // è·å–ç”¨æˆ·æŒ‡å®šçš„åˆ—åè¡Œå·ï¼ˆè½¬æ¢ä¸º0-basedç´¢å¼•ï¼‰
                    const headerRow = parseInt(document.getElementById('headerRowInput').value) || 1;
                    const headerIndex = headerRow - 1;
                    
                    if (jsonData.length < headerRow) {
                        throw new Error(`Excelæ–‡ä»¶è¡Œæ•°ä¸è¶³ï¼Œæ— æ³•è·å–ç¬¬${headerRow}è¡Œçš„åˆ—å`);
                    }

                    // è·å–åˆ—å
                    const headerRowData = jsonData[headerIndex];
                    columnNames = headerRowData.filter(v => v && v.toString().trim()).map(v => v.toString().trim());
                    
                    if (columnNames.length === 0) {
                        throw new Error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„åˆ—å');
                    }

                    // è§£ææ•°æ®ï¼ˆä»åˆ—åè¡Œçš„ä¸‹ä¸€è¡Œå¼€å§‹ï¼‰
                    parsedData = [];
                    const dataStartLine = headerIndex + 1;
                    const totalRows = jsonData.length - dataStartLine;
                    
                    parseProgress.textContent = 'æ­£åœ¨è§£ææ•°æ®... 0%';
                    updateLoadingProgress(40, 'æ­£åœ¨è§£ææ•°æ®...');
                    
                    // åˆ†æ‰¹å¤„ç†æ•°æ®
                    const batchSize = 5000;
                    for (let batchStart = dataStartLine; batchStart < jsonData.length; batchStart += batchSize) {
                        const batchEnd = Math.min(batchStart + batchSize, jsonData.length);
                        
                        for (let i = batchStart; i < batchEnd; i++) {
                            const row = jsonData[i];
                            if (!row || row.length === 0) continue;

                            const rowData = {};
                            let hasValidData = false;
                            
                            columnNames.forEach((col, idx) => {
                                if (idx < row.length) {
                                    const val = row[idx];
                                    if (val !== null && val !== undefined) {
                                        const numVal = parseFloat(val);
                                        if (!isNaN(numVal)) {
                                            rowData[col] = numVal;
                                            hasValidData = true;
                                        } else {
                                            rowData[col] = val;
                                        }
                                    } else {
                                        rowData[col] = null;
                                    }
                                } else {
                                    rowData[col] = null;
                                }
                            });
                            
                            if (hasValidData) {
                                parsedData.push(rowData);
                            }
                        }
                        
                        // æ›´æ–°è¿›åº¦
                    const processed = batchEnd - dataStartLine;
                    const progress = Math.round((processed / totalRows) * 100);
                    // ç¡®ä¿åœ¨å¤„ç†å®Œæ‰€æœ‰æ•°æ®æ—¶ï¼Œè¿›åº¦è¾¾åˆ°100%
                    const overallProgress = batchEnd === jsonData.length ? 100 : 40 + Math.round(progress * 0.6); // 40% - 100%
                    parseProgress.textContent = `æ­£åœ¨è§£ææ•°æ®... ${progress}%`;
                    updateLoadingProgress(overallProgress, `æ­£åœ¨è§£ææ•°æ®... ${progress}%`);
                    }

                    // æ›´æ–°è¿›åº¦åˆ°100%
                    updateLoadingProgress(100, 'Excelæ–‡ä»¶åŠ è½½å®Œæˆ');
                    
                    // æ˜¾ç¤ºåˆ—ååˆ—è¡¨
                    displayColumnList();
                    
                    // æ–‡ä»¶åŠ è½½å®Œæˆï¼Œéšè—è¿›åº¦æ¡
                    const contentBody = document.getElementById('contentBody');
                    if (contentBody) {
                        // ç¡®ä¿æ˜¾ç¤ºåˆ—ååˆ—è¡¨åï¼Œå³ä¾§å†…å®¹åŒºæ¢å¤æ­£å¸¸
                        contentBody.innerHTML = `
                            <div class="empty-state">
                                <h3>ğŸ‘ˆ é€‰æ‹©æ•°æ®åˆ—</h3>
                                <p>ä»å·¦ä¾§åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªåˆ—åï¼ŒæŸ¥çœ‹è¯¥åˆ—çš„æ•°æ®åˆ†æå’Œå¯è§†åŒ–å›¾è¡¨</p>
                            </div>
                        `;
                    }

                    console.log('Excelæ–‡ä»¶åŠ è½½æˆåŠŸ:', {
                        æ–‡ä»¶å: fileName,
                        å·¥ä½œè¡¨: firstSheetName,
                        åˆ—æ•°: columnNames.length,
                        æ•°æ®è¡Œæ•°: parsedData.length
                    });

                } catch (error) {
                    console.error('åŠ è½½Excelæ–‡ä»¶å¤±è´¥:', error);
                    columnList.innerHTML = `<div class="error">ExcelåŠ è½½å¤±è´¥: ${error.message}</div>`;
                    // éšè—å·¦ä¾§æ–‡ä»¶é€‰æ‹©åŒºåŸŸçš„è¿›åº¦æ¡
                    const fileLoadingProgress = document.getElementById('fileLoadingProgress');
                    if (fileLoadingProgress) {
                        fileLoadingProgress.style.display = 'none';
                    }
                }
            }, 0);
        }

        // æ˜¾ç¤ºåŠ è½½è¿›åº¦æ¡
        function showLoadingProgress(message) {
            // åŒæ—¶æ˜¾ç¤ºå·¦ä¾§æ–‡ä»¶é€‰æ‹©åŒºåŸŸçš„è¿›åº¦æ¡å’Œå³ä¾§å†…å®¹åŒºçš„è¿›åº¦æç¤º
            // 1. å·¦ä¾§æ–‡ä»¶é€‰æ‹©åŒºåŸŸçš„è¿›åº¦æ¡
            const fileLoadingProgress = document.getElementById('fileLoadingProgress');
            if (fileLoadingProgress) {
                fileLoadingProgress.style.display = 'block';
            }
            
            // 2. å³ä¾§å†…å®¹åŒºçš„è¿›åº¦æç¤º
            const contentBody = document.getElementById('contentBody');
            contentBody.innerHTML = `
                <div class="loading-container" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 400px; text-align: center;">
                    <div class="loading-spinner" style="width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;"></div>
                    <div class="loading-message" style="font-size: 16px; color: #666; margin-bottom: 10px;">${message}</div>
                    <div class="loading-progress" style="width: 300px; height: 8px; background: #f0f0f0; border-radius: 4px; overflow: hidden; margin-bottom: 10px;">
                        <div class="loading-bar" style="width: 0%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 4px; transition: width 0.3s ease;"></div>
                    </div>
                    <div class="loading-text" style="font-size: 14px; color: #999;">0%</div>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;
        }

        // æ›´æ–°åŠ è½½è¿›åº¦
        function updateLoadingProgress(progress, text) {
            // æ›´æ–°å·¦ä¾§æ–‡ä»¶é€‰æ‹©åŒºåŸŸçš„è¿›åº¦æ¡
            const fileLoadingBar = document.getElementById('fileLoadingBar');
            const fileLoadingText = document.getElementById('fileLoadingText');
            const fileLoadingMessage = document.getElementById('fileLoadingMessage');
            
            if (fileLoadingBar) {
                fileLoadingBar.style.width = `${progress}%`;
            }
            if (fileLoadingText) {
                fileLoadingText.textContent = `${progress}%`;
            }
            if (fileLoadingMessage) {
                // æ ¹æ®è¿›åº¦æ›´æ–°æ¶ˆæ¯æ–‡æœ¬
                if (progress >= 100) {
                    fileLoadingMessage.textContent = 'åŠ è½½å®Œæˆ';
                } else if (text) {
                    // ä»textä¸­æå–çŠ¶æ€æ¶ˆæ¯ï¼Œå»æ‰ç™¾åˆ†æ¯”
                    const message = text.replace(/\d+%/, '').trim();
                    fileLoadingMessage.textContent = message || 'åŠ è½½ä¸­...';
                }
            }
            
            // æ›´æ–°å³ä¾§å†…å®¹åŒºçš„è¿›åº¦æ¡
            const loadingBar = document.querySelector('.loading-bar');
            const loadingText = document.querySelector('.loading-text');
            const loadingMessage = document.querySelector('.loading-message');
            
            if (loadingBar) {
                loadingBar.style.width = `${progress}%`;
            }
            if (loadingText) {
                loadingText.textContent = `${progress}%`;
            }
            if (loadingMessage && text) {
                loadingMessage.textContent = text;
            }
        }

        // æ˜¾ç¤ºåˆ—ååˆ—è¡¨ï¼ˆæ”¯æŒæœç´¢è¿‡æ»¤ï¼‰
        function displayColumnList(searchTerm = '') {
            // éšè—å·¦ä¾§æ–‡ä»¶é€‰æ‹©åŒºåŸŸçš„è¿›åº¦æ¡
            const fileLoadingProgress = document.getElementById('fileLoadingProgress');
            if (fileLoadingProgress) {
                fileLoadingProgress.style.display = 'none';
            }
            
            const columnList = document.getElementById('columnList');
            columnList.innerHTML = '';

            // è¿‡æ»¤åˆ—å
            const filteredColumns = columnNames.filter(col => {
                return col.toLowerCase().includes(searchTerm.toLowerCase());
            });

            filteredColumns.forEach((col, index) => {
                // ä¿ç•™åŸå§‹ç´¢å¼•ï¼Œä»¥ä¾¿æ˜¾ç¤ºæ­£ç¡®çš„åºå·
                const originalIndex = columnNames.indexOf(col);
                const item = document.createElement('div');
                item.className = 'column-item';
                item.textContent = `${originalIndex + 1}. ${col}`;
                item.onclick = (e) => selectColumn(col, item, e);
                item.title = 'ç‚¹å‡»é€‰æ‹© | Ctrl+ç‚¹å‡»å¤šé€‰';
                columnList.appendChild(item);
            });
        }

        // æœç´¢åˆ—å
        function searchColumns() {
            const searchInput = document.getElementById('columnSearchInput');
            if (searchInput) {
                const searchTerm = searchInput.value;
                displayColumnList(searchTerm);
            }
        }

        // ç¡®ä¿æœç´¢äº‹ä»¶ç›‘å¬å™¨æ­£ç¡®ç»‘å®š
        function bindSearchEvent() {
            const searchInput = document.getElementById('columnSearchInput');
            if (searchInput) {
                // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ç›‘å¬å™¨
                searchInput.removeEventListener('input', searchColumns);
                // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
                searchInput.addEventListener('input', searchColumns);
                // åŒæ—¶æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œç¡®ä¿å¯ä»¥è·å–ç„¦ç‚¹
                searchInput.addEventListener('click', function() {
                    this.focus();
                });
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ·»åŠ æœç´¢äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', bindSearchEvent);

        // ç¡®ä¿åœ¨æ˜¾ç¤ºåˆ—ååˆ—è¡¨åé‡æ–°ç»‘å®šäº‹ä»¶
        function displayColumnList(searchTerm = '') {
            const columnList = document.getElementById('columnList');
            columnList.innerHTML = '';

            // è¿‡æ»¤åˆ—å
            const filteredColumns = columnNames.filter(col => {
                return col.toLowerCase().includes(searchTerm.toLowerCase());
            });

            filteredColumns.forEach((col, index) => {
                // ä¿ç•™åŸå§‹ç´¢å¼•ï¼Œä»¥ä¾¿æ˜¾ç¤ºæ­£ç¡®çš„åºå·
                const originalIndex = columnNames.indexOf(col);
                const item = document.createElement('div');
                item.className = 'column-item';
                item.textContent = `${originalIndex + 1}. ${col}`;
                item.onclick = (e) => selectColumn(col, item, e);
                item.title = 'ç‚¹å‡»é€‰æ‹© | Ctrl+ç‚¹å‡»å¤šé€‰';
                columnList.appendChild(item);
            });
            
            // é‡æ–°ç»‘å®šæœç´¢äº‹ä»¶ï¼Œç¡®ä¿äº‹ä»¶ç›‘å¬å™¨å§‹ç»ˆæœ‰æ•ˆ
            bindSearchEvent();
        }

        // é€‰æ‹©åˆ—ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
        function selectColumn(columnName, element, event) {
            // å¦‚æœæŒ‰ä½Ctrlæˆ–Cmdé”®ï¼Œåˆ™å¤šé€‰
            if (event && (event.ctrlKey || event.metaKey)) {
                // åˆ‡æ¢é€‰ä¸­çŠ¶æ€
                element.classList.toggle('selected');
                
                // æ›´æ–°activeç±»ï¼šå¦‚æœè¯¥åˆ—è¢«é€‰ä¸­ï¼Œæ·»åŠ activeï¼›å¦åˆ™ç§»é™¤
                if (element.classList.contains('selected')) {
                    element.classList.add('active');
                    // è‡ªåŠ¨åˆ†é…Yè½´ï¼šå¦‚æœæ˜¯ç¬¬ä¸€ä¸ªé€‰ä¸­çš„åˆ—ï¼Œä½¿ç”¨ä¸»Yè½´ï¼›å¦åˆ™äº¤æ›¿ä½¿ç”¨Yè½´
                    const selectedItems = document.querySelectorAll('.column-item.selected');
                    const axis = selectedItems.length % 2 === 0 ? 'y2' : 'y1'; // è‡ªåŠ¨äº¤æ›¿åˆ†é…Yè½´
                    addChart(columnName, axis);
                } else {
                    element.classList.remove('active');
                    removeChartByColumn(columnName);
                }
                
                // æ›´æ–°æ ‡é¢˜ï¼Œæ˜¾ç¤ºé€‰ä¸­çš„åˆ—æ•°
                const selectedItems = document.querySelectorAll('.column-item.selected');
                document.getElementById('selectedColumnName').textContent = `ğŸ“ˆ å·²é€‰æ‹© ${selectedItems.length} åˆ—`;
            } else {
                // å•é€‰æ¨¡å¼ï¼šæ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.column-item').forEach(item => {
                    item.classList.remove('active', 'selected');
                });
                element.classList.add('active');
                currentSelectedColumn = columnName;

                // æ›´æ–°æ ‡é¢˜
                document.getElementById('selectedColumnName').textContent = `ğŸ“ˆ ${columnName} - æ•°æ®åˆ†æ`;

                // æ˜¾ç¤ºæ•°æ®åˆ†æå’Œå›¾è¡¨ï¼ˆdisplayAnalysiså†…éƒ¨ä¼šè‡ªåŠ¨æ·»åŠ å›¾è¡¨ï¼‰
                displayAnalysis(columnName);
            }
        }

        // æ ¹æ®åˆ—åç§»é™¤å›¾è¡¨
        function removeChartByColumn(columnName) {
            const chart = activeCharts.find(c => c.columnName === columnName);
            if (chart) {
                removeChart(chart.id);
            }
        }

        // æ·»åŠ æ–°å›¾è¡¨
        function addNewChart() {
            if (!parsedData || parsedData.length === 0) {
                alert('è¯·å…ˆåŠ è½½æ–‡ä»¶å¹¶é€‰æ‹©åˆ—');
                return;
            }

            // åˆ›å»ºæ¨¡æ€å¯¹è¯æ¡†
            const modal = document.createElement('div');
            modal.className = 'add-chart-modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            
            const dialog = document.createElement('div');
            dialog.className = 'add-chart-dialog';
            dialog.style.cssText = 'background: white; padding: 30px; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); min-width: 400px;';
            
            // åˆ›å»ºé€‰æ‹©æ¡†
            const select = document.createElement('select');
            select.id = 'columnSelectDialog';
            select.style.cssText = 'width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 1em; margin-bottom: 20px;';
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'è¯·é€‰æ‹©åˆ—...';
            select.appendChild(defaultOption);
            columnNames.forEach(col => {
                const option = document.createElement('option');
                option.value = col;
                option.textContent = col;
                select.appendChild(option);
            });
            
            // åˆ›å»ºæŒ‰é’®
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'å–æ¶ˆ';
            cancelBtn.style.cssText = 'padding: 10px 20px; background: #f0f0f0; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;';
            cancelBtn.onclick = () => {
                modal.remove();
            };
            
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = 'ç¡®å®š';
            confirmBtn.style.cssText = 'padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;';
            confirmBtn.onclick = () => {
                const columnName = select.value;
                if (!columnName) {
                    alert('è¯·é€‰æ‹©ä¸€ä¸ªåˆ—');
                    return;
                }
                // æ·»åŠ å›¾è¡¨
                addChart(columnName);
                // å…³é—­æ¨¡æ€æ¡†
                modal.remove();
            };
            
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = 'display: flex; gap: 10px; justify-content: flex-end;';
            buttonContainer.appendChild(cancelBtn);
            buttonContainer.appendChild(confirmBtn);
            
            dialog.innerHTML = '<h3 style="margin-bottom: 20px; color: #667eea;">é€‰æ‹©è¦æ·»åŠ çš„åˆ—</h3>';
            dialog.appendChild(select);
            dialog.appendChild(buttonContainer);
            
            modal.appendChild(dialog);
            document.body.appendChild(modal);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­ï¼ˆä½†ä¸è¦å…³é—­å¯¹è¯æ¡†æœ¬èº«ï¼‰
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            
            // é˜»æ­¢å¯¹è¯æ¡†å†…çš„ç‚¹å‡»äº‹ä»¶å†’æ³¡
            dialog.onclick = (e) => {
                e.stopPropagation();
            };
        }

        // æ·»åŠ å›¾è¡¨ï¼ˆæ”¯æŒä¸»åæ ‡è½´å’Œæ¬¡åæ ‡è½´ï¼‰
        function addChart(columnName, axis = 'y1') {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥åˆ—çš„å›¾è¡¨
            const existingChart = activeCharts.find(c => c.columnName === columnName);
            if (existingChart) {
                // å¦‚æœå·²å­˜åœ¨ï¼Œé‡æ–°ç»˜åˆ¶
                drawChartForColumn(columnName, existingChart.id);
                return;
            }

            // æ–°å»ºå›¾è¡¨
            chartCounter++;
            const newChartId = `chart_${chartCounter}`;
            
            const chartsContainer = document.getElementById('chartsContainer');
            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart-container';
            chartDiv.id = newChartId;
            
            chartDiv.innerHTML = `
                <div class="chart-header">
                    <h4>å›¾${chartCounter}: ${columnName}</h4>
                    <div class="chart-actions">
                        <button onclick="copyChart('${newChartId}')" class="axis-button" style="margin-right: 10px; padding: 6px 12px; font-size: 13px; background: #9c27b0; color: white;">å¤åˆ¶å›¾è¡¨</button>
                        <button onclick="exportChartToPDF('${newChartId}')" class="axis-button" style="margin-right: 10px; padding: 6px 12px; font-size: 13px; background: #007bff; color: white;">å¯¼å‡ºPDF</button>
                        <button onclick="resetAllSettings('${newChartId}')" class="axis-button" style="margin-right: 10px; padding: 6px 12px; font-size: 13px; background: #dc3545; color: white;">å…¨å±€é‡ç½®</button>
                        <button onclick="showSelectColumnsDialog('${newChartId}')" class="axis-button" style="margin-right: 10px; padding: 6px 12px; font-size: 13px; background: #28a745; color: white;">é€‰æ‹©å¤šåˆ—</button>
                        <button onclick="showDataRangeDialog('${newChartId}')" class="axis-button" style="margin-right: 10px; padding: 6px 12px; font-size: 13px; background: #17a2b8; color: white;">æ•°æ®èŒƒå›´</button>
                        <button onclick="showAxisSettingsDialog('${newChartId}')" class="axis-button" style="margin-right: 10px; padding: 6px 12px; font-size: 13px; background: #ffc107; color: white;">åæ ‡è½´è®¾ç½®</button>
                        <button class="chart-close" onclick="removeChart('${newChartId}')">Ã—</button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas class="chart-canvas" id="${newChartId}_canvas"></canvas>
                </div>
            `;
            
            chartsContainer.appendChild(chartDiv);
            
            // å­˜å‚¨å›¾è¡¨ä¿¡æ¯
            const chartInfo = {
                id: newChartId,
                columnName: columnName,
                chartNumber: chartCounter,
                startPoint: null,
                endPoint: null,
                xMin: null,
                xMax: null,
                y1Min: null,
                y1Max: null,
                y2Min: null,
                y2Max: null,
                axis: axis, // y1: ä¸»Yè½´, y2: æ¬¡Yè½´
                lines: [ // æ”¯æŒå¤šæ¡çº¿æ¡
                    {
                        columnName: columnName,
                        axis: axis,
                        color: lineColors[chartCounter % lineColors.length], // å¾ªç¯ä½¿ç”¨ä¸åŒé¢œè‰²
                        visible: true
                    }
                ]
            };
            activeCharts.push(chartInfo);

            // è®¾ç½®åæ ‡è½´é€‰æ‹©
            const axisSelect = document.getElementById(newChartId + '_axisSelect');
            if (axisSelect) {
                axisSelect.value = axis;
            }

            // ç»˜åˆ¶å›¾è¡¨ï¼ˆå»¶è¿Ÿä»¥ç¡®ä¿DOMå®Œå…¨æ¸²æŸ“ï¼‰
            setTimeout(() => {
                const canvas = document.getElementById(newChartId + '_canvas');
                if (canvas) {
                    drawChartForColumn(columnName, newChartId);
                } else {
                    console.error('Canvaså…ƒç´ æœªæ‰¾åˆ°:', newChartId + '_canvas');
                    // é‡è¯•ä¸€æ¬¡
                    setTimeout(() => {
                        drawChartForColumn(columnName, newChartId);
                    }, 200);
                }
            }, 150);
        }

        // æ˜¾ç¤ºé€‰æ‹©åˆ—å¯¹è¯æ¡†
        function showSelectColumnsDialog(chartId) {
            const chart = activeCharts.find(c => c.id === chartId);
            if (!chart) return;

            // åˆ›å»ºæ¨¡æ€å¯¹è¯æ¡†
            const modal = document.createElement('div');
            modal.className = 'select-columns-modal';
            modal.style.cssText = `
                position: fixed; 
                top: 0; 
                left: 0; 
                width: 100%; 
                height: 100%; 
                background: rgba(0,0,0,0.5); 
                z-index: 10000; 
                display: flex; 
                align-items: center; 
                justify-content: center;
            `;
            
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: white; 
                padding: 20px; 
                border-radius: 10px; 
                box-shadow: 0 10px 40px rgba(0,0,0,0.3); 
                width: 500px; 
                max-height: 80vh;
                display: flex;
                flex-direction: column;
            `;
            
            // å¯¹è¯æ¡†æ ‡é¢˜
            const title = document.createElement('h3');
            title.textContent = 'é€‰æ‹©è¦æ˜¾ç¤ºçš„åˆ—ï¼ˆå¯å¤šé€‰ï¼‰';
            title.style.cssText = `
                margin-bottom: 20px; 
                color: #333; 
                font-size: 18px;
                text-align: center;
                border-bottom: 2px solid #667eea;
                padding-bottom: 10px;
            `;
            dialog.appendChild(title);
            
            // åˆ—é€‰æ‹©åŒºåŸŸ
            const columnsContainer = document.createElement('div');
            columnsContainer.style.cssText = `
                flex: 1;
                overflow-y: auto;
                margin-bottom: 20px;
                padding: 10px;
                background: #f8f9fa;
                border-radius: 8px;
                max-height: 400px;
            `;
            
            // åˆ›å»ºåˆ—é€‰æ‹©é¡¹
                columnNames.forEach((col, index) => {
                    const isSelected = chart.lines.some(line => line.columnName === col);
                    const line = chart.lines.find(line => line.columnName === col);
                    const currentColor = line ? line.color : lineColors[index % lineColors.length];
                    const currentAxis = line ? line.axis : (index % 2 === 0 ? 'y1' : 'y2'); // è‡ªåŠ¨åˆ†é…Yè½´
                    
                    const columnItem = document.createElement('div');
                    columnItem.style.cssText = `
                        display: flex;
                        align-items: center;
                        gap: 15px;
                        padding: 10px;
                        margin-bottom: 8px;
                        background: white;
                        border-radius: 6px;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                    `;
                    
                    // å¤é€‰æ¡†
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `col_${index}`;
                    checkbox.checked = isSelected;
                    checkbox.style.cssText = 'width: 18px; height: 18px;';
                    
                    // åˆ—å
                    const label = document.createElement('label');
                    label.htmlFor = `col_${index}`;
                    label.textContent = col;
                    label.style.cssText = 'flex: 1; font-size: 14px;';
                    
                    // Yè½´é€‰æ‹©
                    const axisSelect = document.createElement('select');
                    axisSelect.className = 'axis-select';
                    axisSelect.style.cssText = 'width: 100px; padding: 5px; border: 1px solid #ddd; border-radius: 3px; font-size: 14px;';
                    
                    const axisOptions = [
                        { value: 'y1', text: 'ä¸»Yè½´' },
                        { value: 'y2', text: 'æ¬¡Yè½´' }
                    ];
                    
                    axisOptions.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt.value;
                        option.textContent = opt.text;
                        if (opt.value === currentAxis) {
                            option.selected = true;
                        }
                        axisSelect.appendChild(option);
                    });
                    
                    // é¢œè‰²é€‰æ‹©å™¨
                    const colorPicker = document.createElement('input');
                    colorPicker.type = 'color';
                    colorPicker.value = currentColor;
                    colorPicker.style.cssText = 'width: 40px; height: 30px; border: none; border-radius: 4px; cursor: pointer;';
                    
                    columnItem.appendChild(checkbox);
                    columnItem.appendChild(label);
                    columnItem.appendChild(axisSelect);
                    columnItem.appendChild(colorPicker);
                    columnsContainer.appendChild(columnItem);
                });
            
            dialog.appendChild(columnsContainer);
            
            // æŒ‰é’®åŒºåŸŸ
            const buttonsContainer = document.createElement('div');
            buttonsContainer.style.cssText = `
                display: flex;
                gap: 15px;
                justify-content: flex-end;
                padding-top: 15px;
                border-top: 1px solid #e0e0e0;
            `;
            
            // å–æ¶ˆæŒ‰é’®
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'å–æ¶ˆ';
            cancelBtn.style.cssText = `
                padding: 10px 20px;
                background: #f0f0f0;
                color: #333;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: background-color 0.3s;
            `;
            cancelBtn.onclick = () => modal.remove();
            cancelBtn.onmouseover = () => cancelBtn.style.backgroundColor = '#e0e0e0';
            cancelBtn.onmouseout = () => cancelBtn.style.backgroundColor = '#f0f0f0';
            
            // ç¡®å®šæŒ‰é’®
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = 'ç¡®å®š';
            confirmBtn.style.cssText = `
                padding: 10px 20px;
                background: #667eea;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: background-color 0.3s;
            `;
            confirmBtn.onclick = () => {
                // å¤„ç†ç”¨æˆ·é€‰æ‹©
                const selectedLines = [];
                const columnItems = columnsContainer.querySelectorAll('div');
                
                let yAxisIndex = 0;
                columnItems.forEach((item, index) => {
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    const colorPicker = item.querySelector('input[type="color"]');
                    const axisSelect = item.querySelector('.axis-select');
                    
                    if (checkbox.checked) {
                        selectedLines.push({
                            columnName: columnNames[index],
                            axis: axisSelect ? axisSelect.value : (yAxisIndex % 2 === 0 ? 'y1' : 'y2'), // è‡ªåŠ¨åˆ†é…Yè½´
                            color: colorPicker.value,
                            visible: true
                        });
                        yAxisIndex++;
                    }
                });
                
                // æ›´æ–°å›¾è¡¨çº¿æ¡é…ç½®
                chart.lines = selectedLines;
                
                // é‡æ–°ç»˜åˆ¶å›¾è¡¨
                drawChartForColumn(chart.columnName, chart.id);
                
                // å…³é—­å¯¹è¯æ¡†
                modal.remove();
            };
            confirmBtn.onmouseover = () => confirmBtn.style.backgroundColor = '#5568d3';
            confirmBtn.onmouseout = () => confirmBtn.style.backgroundColor = '#667eea';
            
            buttonsContainer.appendChild(cancelBtn);
            buttonsContainer.appendChild(confirmBtn);
            dialog.appendChild(buttonsContainer);
            
            modal.appendChild(dialog);
            document.body.appendChild(modal);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­å¯¹è¯æ¡†
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
        }

        // æ˜¾ç¤ºæ•°æ®èŒƒå›´è®¾ç½®å¯¹è¯æ¡†
        function showDataRangeDialog(chartId) {
            const chart = activeCharts.find(c => c.id === chartId);
            if (!chart) return;

            // åˆ›å»ºæ¨¡æ€å¯¹è¯æ¡†
            const modal = document.createElement('div');
            modal.className = 'data-range-modal';
            modal.style.cssText = `
                position: fixed; 
                top: 0; 
                left: 0; 
                width: 100%; 
                height: 100%; 
                background: rgba(0,0,0,0.5); 
                z-index: 10000; 
                display: flex; 
                align-items: center; 
                justify-content: center;
            `;
            
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: white; 
                padding: 20px; 
                border-radius: 10px; 
                box-shadow: 0 10px 40px rgba(0,0,0,0.3); 
                width: 400px;
            `;
            
            // å¯¹è¯æ¡†æ ‡é¢˜
            const title = document.createElement('h3');
            title.textContent = 'ğŸ“Š æ•°æ®èŒƒå›´è®¾ç½®';
            title.style.cssText = `
                margin-bottom: 20px; 
                color: #333; 
                font-size: 18px;
                text-align: center;
                border-bottom: 2px solid #17a2b8;
                padding-bottom: 10px;
            `;
            dialog.appendChild(title);
            
            // æ•°æ®èŒƒå›´è®¾ç½®åŒºåŸŸ
            const settingsContainer = document.createElement('div');
            settingsContainer.style.cssText = `
                margin-bottom: 20px;
            `;
            
            // èµ·å§‹ç‚¹å’Œç»“æŸç‚¹è¾“å…¥æ¡†
            const rangeInputs = document.createElement('div');
            rangeInputs.style.cssText = `
                display: flex;
                flex-direction: column;
                gap: 15px;
                margin-bottom: 20px;
            `;
            
            // èµ·å§‹ç‚¹è¡Œ
            const startRow = document.createElement('div');
            startRow.style.cssText = `
                display: flex;
                align-items: center;
                gap: 10px;
            `;
            
            const startLabel = document.createElement('label');
            startLabel.textContent = 'èµ·å§‹ç‚¹:';
            startLabel.style.cssText = `
                font-size: 14px;
                font-weight: 600;
                color: #555;
                min-width: 80px;
            `;
            startRow.appendChild(startLabel);
            
            const startInput = document.createElement('input');
            startInput.type = 'number';
            startInput.id = `${chartId}_startPoint`;
            startInput.placeholder = 'èµ·å§‹ç‚¹';
            startInput.step = '1';
            startInput.value = chart.startPoint || '';
            startInput.className = 'axis-input';
            startInput.style.cssText = `
                flex: 1;
                min-width: 150px;
                padding: 9px 12px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 14px;
                background: white;
                transition: all 0.3s ease;
                box-shadow: inset 0 1px 2px rgba(0,0,0,0.075);
            `;
            startRow.appendChild(startInput);
            
            // ç»“æŸç‚¹è¡Œ
            const endRow = document.createElement('div');
            endRow.style.cssText = `
                display: flex;
                align-items: center;
                gap: 10px;
            `;
            
            const endLabel = document.createElement('label');
            endLabel.textContent = 'ç»“æŸç‚¹:';
            endLabel.style.cssText = `
                font-size: 14px;
                font-weight: 600;
                color: #555;
                min-width: 80px;
            `;
            endRow.appendChild(endLabel);
            
            const endInput = document.createElement('input');
            endInput.type = 'number';
            endInput.id = `${chartId}_endPoint`;
            endInput.placeholder = 'ç»“æŸç‚¹';
            endInput.step = '1';
            endInput.value = chart.endPoint || '';
            endInput.className = 'axis-input';
            endInput.style.cssText = `
                flex: 1;
                min-width: 150px;
                padding: 9px 12px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 14px;
                background: white;
                transition: all 0.3s ease;
                box-shadow: inset 0 1px 2px rgba(0,0,0,0.075);
            `;
            endRow.appendChild(endInput);
            
            // å°†è¡Œæ·»åŠ åˆ°å®¹å™¨
            rangeInputs.appendChild(startRow);
            rangeInputs.appendChild(endRow);
            
            settingsContainer.appendChild(rangeInputs);
            
            dialog.appendChild(settingsContainer);
            
            // æŒ‰é’®åŒºåŸŸ
            const buttonsContainer = document.createElement('div');
            buttonsContainer.style.cssText = `
                display: flex;
                gap: 15px;
                justify-content: flex-end;
                padding-top: 15px;
                border-top: 1px solid #e0e0e0;
            `;
            
            // é‡ç½®æŒ‰é’®
            const resetBtn = document.createElement('button');
            resetBtn.textContent = 'é‡ç½®';
            resetBtn.style.cssText = `
                padding: 9px 16px;
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                color: #495057;
                border: 1px solid #dee2e6;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: all 0.3s ease;
            `;
            resetBtn.onclick = () => {
                startInput.value = '';
                endInput.value = '';
                chart.startPoint = null;
                chart.endPoint = null;
                drawChartForColumn(chart.columnName, chart.id);
                modal.remove();
            };
            resetBtn.onmouseover = () => {
                resetBtn.style.background = 'linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%)';
                resetBtn.style.borderColor = '#ced4da';
                resetBtn.style.transform = 'translateY(-1px)';
                resetBtn.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
            };
            resetBtn.onmouseout = () => {
                resetBtn.style.background = 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)';
                resetBtn.style.borderColor = '#dee2e6';
                resetBtn.style.transform = 'translateY(0)';
                resetBtn.style.boxShadow = 'none';
            };
            buttonsContainer.appendChild(resetBtn);
            
            // å–æ¶ˆæŒ‰é’®
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'å–æ¶ˆ';
            cancelBtn.style.cssText = `
                padding: 9px 16px;
                background: #f0f0f0;
                color: #333;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: background-color 0.3s;
            `;
            cancelBtn.onclick = () => modal.remove();
            cancelBtn.onmouseover = () => cancelBtn.style.backgroundColor = '#e0e0e0';
            cancelBtn.onmouseout = () => cancelBtn.style.backgroundColor = '#f0f0f0';
            buttonsContainer.appendChild(cancelBtn);
            
            // åº”ç”¨æŒ‰é’®
            const applyBtn = document.createElement('button');
            applyBtn.textContent = 'åº”ç”¨';
            applyBtn.style.cssText = `
                padding: 9px 16px;
                background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: all 0.3s ease;
            `;
            applyBtn.onclick = () => {
                const startPoint = startInput.value ? parseInt(startInput.value) : null;
                const endPoint = endInput.value ? parseInt(endInput.value) : null;
                
                if (startPoint !== null && endPoint !== null && startPoint >= endPoint) {
                    alert('èµ·å§‹ç‚¹å¿…é¡»å°äºç»“æŸç‚¹');
                    return;
                }
                
                chart.startPoint = startPoint;
                chart.endPoint = endPoint;
                
                // é‡æ–°ç»˜åˆ¶å›¾è¡¨
                drawChartForColumn(chart.columnName, chart.id);
                
                // å…³é—­å¯¹è¯æ¡†
                modal.remove();
            };
            applyBtn.onmouseover = () => {
                applyBtn.style.background = 'linear-gradient(135deg, #138496 0%, #117a8b 100%)';
                applyBtn.style.transform = 'translateY(-1px)';
                applyBtn.style.boxShadow = '0 4px 8px rgba(23, 162, 184, 0.3)';
            };
            applyBtn.onmouseout = () => {
                applyBtn.style.background = 'linear-gradient(135deg, #17a2b8 0%, #138496 100%)';
                applyBtn.style.transform = 'translateY(0)';
                applyBtn.style.boxShadow = '0 2px 4px rgba(23, 162, 184, 0.3)';
            };
            buttonsContainer.appendChild(applyBtn);
            
            dialog.appendChild(buttonsContainer);
            
            modal.appendChild(dialog);
            document.body.appendChild(modal);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­å¯¹è¯æ¡†
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
        }

        // æ˜¾ç¤ºåæ ‡è½´è®¾ç½®å¯¹è¯æ¡†
        function showAxisSettingsDialog(chartId) {
            const chart = activeCharts.find(c => c.id === chartId);
            if (!chart) return;

            // åˆ›å»ºæ¨¡æ€å¯¹è¯æ¡†
            const modal = document.createElement('div');
            modal.className = 'axis-settings-modal';
            modal.style.cssText = `
                position: fixed; 
                top: 0; 
                left: 0; 
                width: 100%; 
                height: 100%; 
                background: rgba(0,0,0,0.5); 
                z-index: 10000; 
                display: flex; 
                align-items: center; 
                justify-content: center;
            `;
            
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: white; 
                padding: 20px; 
                border-radius: 10px; 
                box-shadow: 0 10px 40px rgba(0,0,0,0.3); 
                width: 500px;
                max-width: 90vw;
            `;
            
            // å¯¹è¯æ¡†æ ‡é¢˜
            const title = document.createElement('h3');
            title.textContent = 'ğŸ“ åæ ‡è½´è®¾ç½®';
            title.style.cssText = `
                margin-bottom: 20px; 
                color: #333; 
                font-size: 18px;
                text-align: center;
                border-bottom: 2px solid #ffc107;
                padding-bottom: 10px;
            `;
            dialog.appendChild(title);
            
            // åæ ‡è½´è®¾ç½®åŒºåŸŸ
            const settingsContainer = document.createElement('div');
            settingsContainer.style.cssText = `
                margin-bottom: 20px;
            `;
            
            // Xè½´è®¾ç½®
            const xAxisSection = document.createElement('div');
            xAxisSection.style.cssText = `
                background: #f8f9fa;
                border-radius: 6px;
                padding: 15px;
                margin-bottom: 15px;
                border: 1px solid #e9ecef;
            `;
            
            const xAxisTitle = document.createElement('h4');
            xAxisTitle.textContent = 'Xè½´';
            xAxisTitle.style.cssText = `
                margin: 0 0 12px 0;
                font-size: 14px;
                font-weight: 600;
                color: #6c757d;
            `;
            xAxisSection.appendChild(xAxisTitle);
            
            const xAxisInputs = document.createElement('div');
            xAxisInputs.style.cssText = `
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 10px;
                flex-wrap: wrap;
            `;
            
            const xMinLabel = document.createElement('label');
            xMinLabel.textContent = 'æœ€å°å€¼:';
            xMinLabel.style.cssText = `
                font-size: 13px;
                font-weight: 500;
                color: #555;
                min-width: 60px;
            `;
            xAxisInputs.appendChild(xMinLabel);
            
            const xMinInput = document.createElement('input');
            xMinInput.type = 'number';
            xMinInput.id = `${chartId}_xMin`;
            xMinInput.placeholder = 'æœ€å°å€¼';
            xMinInput.step = '1';
            xMinInput.value = chart.xMin || '';
            xMinInput.className = 'axis-input';
            xMinInput.style.cssText = `
                width: 100px;
                padding: 8px 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
                font-size: 13px;
                background: white;
            `;
            xAxisInputs.appendChild(xMinInput);
            
            const xSeparator = document.createElement('span');
            xSeparator.textContent = '-';
            xSeparator.style.cssText = `
                color: #666;
                font-weight: bold;
            `;
            xAxisInputs.appendChild(xSeparator);
            
            const xMaxLabel = document.createElement('label');
            xMaxLabel.textContent = 'æœ€å¤§å€¼:';
            xMaxLabel.style.cssText = `
                font-size: 13px;
                font-weight: 500;
                color: #555;
                min-width: 60px;
            `;
            xAxisInputs.appendChild(xMaxLabel);
            
            const xMaxInput = document.createElement('input');
            xMaxInput.type = 'number';
            xMaxInput.id = `${chartId}_xMax`;
            xMaxInput.placeholder = 'æœ€å¤§å€¼';
            xMaxInput.step = '1';
            xMaxInput.value = chart.xMax || '';
            xMaxInput.className = 'axis-input';
            xMaxInput.style.cssText = `
                width: 100px;
                padding: 8px 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
                font-size: 13px;
                background: white;
            `;
            xAxisInputs.appendChild(xMaxInput);
            
            const xApplyBtn = document.createElement('button');
            xApplyBtn.textContent = 'åº”ç”¨';
            xApplyBtn.style.cssText = `
                padding: 8px 12px;
                background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 13px;
                font-weight: 600;
                transition: all 0.2s ease;
            `;
            xApplyBtn.onclick = () => {
                const xMin = xMinInput.value ? parseFloat(xMinInput.value) : null;
                const xMax = xMaxInput.value ? parseFloat(xMaxInput.value) : null;
                
                if (xMin !== null && xMax !== null && xMin >= xMax) {
                    alert('æœ€å°å€¼å¿…é¡»å°äºæœ€å¤§å€¼');
                    return;
                }
                
                chart.xMin = xMin;
                chart.xMax = xMax;
                drawChartForColumn(chart.columnName, chart.id);
            };
            xApplyBtn.onmouseover = () => {
                xApplyBtn.style.background = 'linear-gradient(135deg, #e0a800 0%, #d39e00 100%)';
            };
            xAxisInputs.appendChild(xApplyBtn);
            
            const xResetBtn = document.createElement('button');
            xResetBtn.textContent = 'é‡ç½®';
            xResetBtn.style.cssText = `
                padding: 8px 12px;
                background: #f0f0f0;
                color: #666;
                border: 1px solid #ddd;
                border-radius: 5px;
                cursor: pointer;
                font-size: 13px;
                font-weight: 600;
                transition: all 0.2s ease;
            `;
            xResetBtn.onclick = () => {
                xMinInput.value = '';
                xMaxInput.value = '';
                chart.xMin = null;
                chart.xMax = null;
                drawChartForColumn(chart.columnName, chart.id);
            };
            xAxisInputs.appendChild(xResetBtn);
            
            xAxisSection.appendChild(xAxisInputs);
            settingsContainer.appendChild(xAxisSection);
            
            // ä¸»Yè½´è®¾ç½®
            const y1AxisSection = document.createElement('div');
            y1AxisSection.style.cssText = `
                background: #f8f9fa;
                border-radius: 6px;
                padding: 15px;
                margin-bottom: 15px;
                border: 1px solid #e9ecef;
            `;
            
            const y1AxisTitle = document.createElement('h4');
            y1AxisTitle.textContent = 'ä¸»Yè½´';
            y1AxisTitle.style.cssText = `
                margin: 0 0 12px 0;
                font-size: 14px;
                font-weight: 600;
                color: #6c757d;
            `;
            y1AxisSection.appendChild(y1AxisTitle);
            
            const y1AxisInputs = document.createElement('div');
            y1AxisInputs.style.cssText = `
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 10px;
                flex-wrap: wrap;
            `;
            
            const y1MinLabel = document.createElement('label');
            y1MinLabel.textContent = 'æœ€å°å€¼:';
            y1MinLabel.style.cssText = `
                font-size: 13px;
                font-weight: 500;
                color: #555;
                min-width: 60px;
            `;
            y1AxisInputs.appendChild(y1MinLabel);
            
            const y1MinInput = document.createElement('input');
            y1MinInput.type = 'number';
            y1MinInput.id = `${chartId}_y1Min`;
            y1MinInput.placeholder = 'æœ€å°å€¼';
            y1MinInput.step = '0.01';
            y1MinInput.value = chart.y1Min || '';
            y1MinInput.className = 'axis-input';
            y1MinInput.style.cssText = `
                width: 100px;
                padding: 8px 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
                font-size: 13px;
                background: white;
            `;
            y1AxisInputs.appendChild(y1MinInput);
            
            const y1Separator = document.createElement('span');
            y1Separator.textContent = '-';
            y1Separator.style.cssText = `
                color: #666;
                font-weight: bold;
            `;
            y1AxisInputs.appendChild(y1Separator);
            
            const y1MaxLabel = document.createElement('label');
            y1MaxLabel.textContent = 'æœ€å¤§å€¼:';
            y1MaxLabel.style.cssText = `
                font-size: 13px;
                font-weight: 500;
                color: #555;
                min-width: 60px;
            `;
            y1AxisInputs.appendChild(y1MaxLabel);
            
            const y1MaxInput = document.createElement('input');
            y1MaxInput.type = 'number';
            y1MaxInput.id = `${chartId}_y1Max`;
            y1MaxInput.placeholder = 'æœ€å¤§å€¼';
            y1MaxInput.step = '0.01';
            y1MaxInput.value = chart.y1Max || '';
            y1MaxInput.className = 'axis-input';
            y1MaxInput.style.cssText = `
                width: 100px;
                padding: 8px 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
                font-size: 13px;
                background: white;
            `;
            y1AxisInputs.appendChild(y1MaxInput);
            
            const y1ApplyBtn = document.createElement('button');
            y1ApplyBtn.textContent = 'åº”ç”¨';
            y1ApplyBtn.style.cssText = `
                padding: 8px 12px;
                background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 13px;
                font-weight: 600;
                transition: all 0.2s ease;
            `;
            y1ApplyBtn.onclick = () => {
                const y1Min = y1MinInput.value ? parseFloat(y1MinInput.value) : null;
                const y1Max = y1MaxInput.value ? parseFloat(y1MaxInput.value) : null;
                
                if (y1Min !== null && y1Max !== null && y1Min >= y1Max) {
                    alert('æœ€å°å€¼å¿…é¡»å°äºæœ€å¤§å€¼');
                    return;
                }
                
                chart.y1Min = y1Min;
                chart.y1Max = y1Max;
                drawChartForColumn(chart.columnName, chart.id);
            };
            y1ApplyBtn.onmouseover = () => {
                y1ApplyBtn.style.background = 'linear-gradient(135deg, #0056b3 0%, #004085 100%)';
            };
            y1AxisInputs.appendChild(y1ApplyBtn);
            
            const y1ResetBtn = document.createElement('button');
            y1ResetBtn.textContent = 'é‡ç½®';
            y1ResetBtn.style.cssText = `
                padding: 8px 12px;
                background: #f0f0f0;
                color: #666;
                border: 1px solid #ddd;
                border-radius: 5px;
                cursor: pointer;
                font-size: 13px;
                font-weight: 600;
                transition: all 0.2s ease;
            `;
            y1ResetBtn.onclick = () => {
                y1MinInput.value = '';
                y1MaxInput.value = '';
                chart.y1Min = null;
                chart.y1Max = null;
                drawChartForColumn(chart.columnName, chart.id);
            };
            y1AxisInputs.appendChild(y1ResetBtn);
            
            y1AxisSection.appendChild(y1AxisInputs);
            settingsContainer.appendChild(y1AxisSection);
            
            // æ¬¡Yè½´è®¾ç½®
            const y2AxisSection = document.createElement('div');
            y2AxisSection.style.cssText = `
                background: #f8f9fa;
                border-radius: 6px;
                padding: 15px;
                margin-bottom: 15px;
                border: 1px solid #e9ecef;
            `;
            
            const y2AxisTitle = document.createElement('h4');
            y2AxisTitle.textContent = 'æ¬¡Yè½´';
            y2AxisTitle.style.cssText = `
                margin: 0 0 12px 0;
                font-size: 14px;
                font-weight: 600;
                color: #6c757d;
            `;
            y2AxisSection.appendChild(y2AxisTitle);
            
            const y2AxisInputs = document.createElement('div');
            y2AxisInputs.style.cssText = `
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 10px;
                flex-wrap: wrap;
            `;
            
            const y2MinLabel = document.createElement('label');
            y2MinLabel.textContent = 'æœ€å°å€¼:';
            y2MinLabel.style.cssText = `
                font-size: 13px;
                font-weight: 500;
                color: #555;
                min-width: 60px;
            `;
            y2AxisInputs.appendChild(y2MinLabel);
            
            const y2MinInput = document.createElement('input');
            y2MinInput.type = 'number';
            y2MinInput.id = `${chartId}_y2Min`;
            y2MinInput.placeholder = 'æœ€å°å€¼';
            y2MinInput.step = '0.01';
            y2MinInput.value = chart.y2Min || '';
            y2MinInput.className = 'axis-input';
            y2MinInput.style.cssText = `
                width: 100px;
                padding: 8px 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
                font-size: 13px;
                background: white;
            `;
            y2AxisInputs.appendChild(y2MinInput);
            
            const y2Separator = document.createElement('span');
            y2Separator.textContent = '-';
            y2Separator.style.cssText = `
                color: #666;
                font-weight: bold;
            `;
            y2AxisInputs.appendChild(y2Separator);
            
            const y2MaxLabel = document.createElement('label');
            y2MaxLabel.textContent = 'æœ€å¤§å€¼:';
            y2MaxLabel.style.cssText = `
                font-size: 13px;
                font-weight: 500;
                color: #555;
                min-width: 60px;
            `;
            y2AxisInputs.appendChild(y2MaxLabel);
            
            const y2MaxInput = document.createElement('input');
            y2MaxInput.type = 'number';
            y2MaxInput.id = `${chartId}_y2Max`;
            y2MaxInput.placeholder = 'æœ€å¤§å€¼';
            y2MaxInput.step = '0.01';
            y2MaxInput.value = chart.y2Max || '';
            y2MaxInput.className = 'axis-input';
            y2MaxInput.style.cssText = `
                width: 100px;
                padding: 8px 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
                font-size: 13px;
                background: white;
            `;
            y2AxisInputs.appendChild(y2MaxInput);
            
            const y2ApplyBtn = document.createElement('button');
            y2ApplyBtn.textContent = 'åº”ç”¨';
            y2ApplyBtn.style.cssText = `
                padding: 8px 12px;
                background: linear-gradient(135deg, #28a745 0%, #218838 100%);
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 13px;
                font-weight: 600;
                transition: all 0.2s ease;
            `;
            y2ApplyBtn.onclick = () => {
                const y2Min = y2MinInput.value ? parseFloat(y2MinInput.value) : null;
                const y2Max = y2MaxInput.value ? parseFloat(y2MaxInput.value) : null;
                
                if (y2Min !== null && y2Max !== null && y2Min >= y2Max) {
                    alert('æœ€å°å€¼å¿…é¡»å°äºæœ€å¤§å€¼');
                    return;
                }
                
                chart.y2Min = y2Min;
                chart.y2Max = y2Max;
                drawChartForColumn(chart.columnName, chart.id);
            };
            y2ApplyBtn.onmouseover = () => {
                y2ApplyBtn.style.background = 'linear-gradient(135deg, #218838 0%, #1e7e34 100%)';
            };
            y2AxisInputs.appendChild(y2ApplyBtn);
            
            const y2ResetBtn = document.createElement('button');
            y2ResetBtn.textContent = 'é‡ç½®';
            y2ResetBtn.style.cssText = `
                padding: 8px 12px;
                background: #f0f0f0;
                color: #666;
                border: 1px solid #ddd;
                border-radius: 5px;
                cursor: pointer;
                font-size: 13px;
                font-weight: 600;
                transition: all 0.2s ease;
            `;
            y2ResetBtn.onclick = () => {
                y2MinInput.value = '';
                y2MaxInput.value = '';
                chart.y2Min = null;
                chart.y2Max = null;
                drawChartForColumn(chart.columnName, chart.id);
            };
            y2AxisInputs.appendChild(y2ResetBtn);
            
            y2AxisSection.appendChild(y2AxisInputs);
            settingsContainer.appendChild(y2AxisSection);
            
            dialog.appendChild(settingsContainer);
            
            // æŒ‰é’®åŒºåŸŸ
            const buttonsContainer = document.createElement('div');
            buttonsContainer.style.cssText = `
                display: flex;
                gap: 15px;
                justify-content: flex-end;
                padding-top: 15px;
                border-top: 1px solid #e0e0e0;
            `;
            
            // ç¡®å®šæŒ‰é’®
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = 'ç¡®å®š';
            confirmBtn.style.cssText = `
                padding: 9px 16px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: all 0.3s ease;
            `;
            confirmBtn.onclick = () => {
                // å…³é—­å¯¹è¯æ¡†
                modal.remove();
            };
            confirmBtn.onmouseover = () => {
                confirmBtn.style.background = 'linear-gradient(135deg, #5568d3 0%, #6a4099 100%)';
                confirmBtn.style.transform = 'translateY(-1px)';
            };
            confirmBtn.onmouseout = () => {
                confirmBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                confirmBtn.style.transform = 'translateY(0)';
            };
            
            buttonsContainer.appendChild(confirmBtn);
            dialog.appendChild(buttonsContainer);
            
            modal.appendChild(dialog);
            document.body.appendChild(modal);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­å¯¹è¯æ¡†
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
        }

        // æ”¹å˜å›¾è¡¨ä½¿ç”¨çš„åæ ‡è½´
        function changeChartAxis(chartId, axis) {
            const chartInfo = activeCharts.find(c => c.id === chartId);
            if (chartInfo) {
                // æ›´æ–°ä¸»åˆ—çš„åæ ‡è½´
                chartInfo.axis = axis;
                
                // å¦‚æœåªæœ‰ä¸€æ¡çº¿ï¼Œä¹Ÿæ›´æ–°è¯¥çº¿çš„åæ ‡è½´
                if (chartInfo.lines && chartInfo.lines.length === 1) {
                    chartInfo.lines[0].axis = axis;
                }
                
                // é‡æ–°ç»˜åˆ¶å›¾è¡¨
                drawChartForColumn(chartInfo.columnName, chartId);
            }
        }


        // æ›´æ–°æ•°æ®ç‚¹èŒƒå›´
        function updateDataRange(chartId) {
            const chartInfo = activeCharts.find(c => c.id === chartId);
            if (!chartInfo) return;

            const startPointInput = document.getElementById(chartId + '_startPoint');
            const endPointInput = document.getElementById(chartId + '_endPoint');
            const startPoint = startPointInput.value ? parseInt(startPointInput.value) : null;
            const endPoint = endPointInput.value ? parseInt(endPointInput.value) : null;
            
            if (startPoint !== null && endPoint !== null && startPoint >= endPoint) {
                alert('èµ·å§‹ç‚¹å¿…é¡»å°äºç»“æŸç‚¹');
                return;
            }
            
            chartInfo.startPoint = startPoint;
            chartInfo.endPoint = endPoint;

            // é‡æ–°ç»˜åˆ¶å›¾è¡¨
            drawChartForColumn(chartInfo.columnName, chartId);
        }

        // æ›´æ–°å›¾è¡¨åæ ‡è½´
        function updateChartAxis(chartId, axis) {
            const chartInfo = activeCharts.find(c => c.id === chartId);
            if (!chartInfo) return;

            if (axis === 'x') {
                const xMinInput = document.getElementById(chartId + '_xMin');
                const xMaxInput = document.getElementById(chartId + '_xMax');
                const xMin = xMinInput.value ? parseFloat(xMinInput.value) : null;
                const xMax = xMaxInput.value ? parseFloat(xMaxInput.value) : null;
                
                if (xMin !== null && xMax !== null && xMin >= xMax) {
                    alert('Xè½´æœ€å°å€¼å¿…é¡»å°äºæœ€å¤§å€¼');
                    return;
                }
                
                chartInfo.xMin = xMin;
                chartInfo.xMax = xMax;
            } else if (axis === 'y1') {
                const yMinInput = document.getElementById(chartId + '_y1Min');
                const yMaxInput = document.getElementById(chartId + '_y1Max');
                const yMin = yMinInput.value ? parseFloat(yMinInput.value) : null;
                const yMax = yMaxInput.value ? parseFloat(yMaxInput.value) : null;
                
                if (yMin !== null && yMax !== null && yMin >= yMax) {
                    alert('Yè½´æœ€å°å€¼å¿…é¡»å°äºæœ€å¤§å€¼');
                    return;
                }
                
                chartInfo.y1Min = yMin;
                chartInfo.y1Max = yMax;
            } else if (axis === 'y2') {
                const yMinInput = document.getElementById(chartId + '_y2Min');
                const yMaxInput = document.getElementById(chartId + '_y2Max');
                const yMin = yMinInput.value ? parseFloat(yMinInput.value) : null;
                const yMax = yMaxInput.value ? parseFloat(yMaxInput.value) : null;
                
                if (yMin !== null && yMax !== null && yMin >= yMax) {
                    alert('æ¬¡Yè½´æœ€å°å€¼å¿…é¡»å°äºæœ€å¤§å€¼');
                    return;
                }
                
                chartInfo.y2Min = yMin;
                chartInfo.y2Max = yMax;
            }

            // é‡æ–°ç»˜åˆ¶å›¾è¡¨
            drawChartForColumn(chartInfo.columnName, chartId);
        }

        // å…¨å±€é‡ç½®å‡½æ•°
        function resetAllSettings(chartId) {
            const chartInfo = activeCharts.find(c => c.id === chartId);
            if (!chartInfo) return;

            // 1. é‡ç½®æ•°æ®èŒƒå›´è¾“å…¥æ¡†
            const startPointInput = document.getElementById(chartId + '_startPoint');
            const endPointInput = document.getElementById(chartId + '_endPoint');
            if (startPointInput) startPointInput.value = '';
            if (endPointInput) endPointInput.value = '';

            // 2. é‡ç½®Xè½´è¾“å…¥æ¡†
            const xMinInput = document.getElementById(chartId + '_xMin');
            const xMaxInput = document.getElementById(chartId + '_xMax');
            if (xMinInput) xMinInput.value = '';
            if (xMaxInput) xMaxInput.value = '';

            // 3. é‡ç½®ä¸»Yè½´è¾“å…¥æ¡†
            const y1MinInput = document.getElementById(chartId + '_y1Min');
            const y1MaxInput = document.getElementById(chartId + '_y1Max');
            if (y1MinInput) y1MinInput.value = '';
            if (y1MaxInput) y1MaxInput.value = '';

            // 4. é‡ç½®æ¬¡Yè½´è¾“å…¥æ¡†
            const y2MinInput = document.getElementById(chartId + '_y2Min');
            const y2MaxInput = document.getElementById(chartId + '_y2Max');
            if (y2MinInput) y2MinInput.value = '';
            if (y2MaxInput) y2MaxInput.value = '';

            // 5. é‡ç½®æ‰€æœ‰å›¾è¡¨è®¾ç½®
            chartInfo.startPoint = null;
            chartInfo.endPoint = null;
            chartInfo.xMin = null;
            chartInfo.xMax = null;
            chartInfo.y1Min = null;
            chartInfo.y1Max = null;
            chartInfo.y2Min = null;
            chartInfo.y2Max = null;

            // 6. é‡æ–°ç»˜åˆ¶å›¾è¡¨
            drawChartForColumn(chartInfo.columnName, chartId);
        }

        // å¤åˆ¶å›¾è¡¨å‡½æ•° - å¤åˆ¶åˆ°ç³»ç»Ÿå‰ªè´´æ¿
        function copyChart(originalChartId) {
            // 1. æ‰¾åˆ°åŸå§‹å›¾è¡¨
            const originalChart = activeCharts.find(c => c.id === originalChartId);
            if (!originalChart) {
                console.error('åŸå§‹å›¾è¡¨æœªæ‰¾åˆ°:', originalChartId);
                return;
            }

            // 2. æ‰¾åˆ°Canvaså…ƒç´ 
            const canvasElement = document.getElementById(`${originalChartId}_canvas`);
            if (!canvasElement) {
                console.error('Canvaså…ƒç´ æœªæ‰¾åˆ°:', `${originalChartId}_canvas`);
                return;
            }
            
            try {
                // 3. å°†Canvasè½¬æ¢ä¸ºBlobå¯¹è±¡
                canvasElement.toBlob(async (blob) => {
                    if (!blob) {
                        console.error('Canvasè½¬æ¢ä¸ºBlobå¤±è´¥');
                        return;
                    }
                    
                    // 4. åˆ›å»ºClipboardItemå¯¹è±¡
                    const clipboardItem = new ClipboardItem({ 'image/png': blob });
                    
                    // 5. å¤åˆ¶åˆ°å‰ªè´´æ¿
                    await navigator.clipboard.write([clipboardItem]);
                    
                    // 6. æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
                    showCopySuccess();
                }, 'image/png', 1.0);
            } catch (error) {
                console.error('å¤åˆ¶åˆ°å‰ªè´´æ¿å¤±è´¥:', error);
                // é™çº§å¤„ç†ï¼šä½¿ç”¨ä¼ ç»Ÿçš„å¤åˆ¶æ–¹å¼
                fallbackCopyChart(originalChartId);
            }
        }
        
        // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
        function showCopySuccess() {
            // åˆ›å»ºæç¤ºå…ƒç´ 
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4caf50;
                color: white;
                padding: 12px 20px;
                border-radius: 5px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                z-index: 10000;
                font-size: 14px;
                transition: all 0.3s ease;
            `;
            successDiv.textContent = 'å›¾è¡¨å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œå¯ä»¥ç²˜è´´åˆ°å…¶ä»–åº”ç”¨ç¨‹åºä¸­ï¼';
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(successDiv);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                successDiv.style.opacity = '0';
                successDiv.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(successDiv);
                }, 300);
            }, 3000);
        }
        
        // é™çº§å¤åˆ¶å‡½æ•°ï¼ˆå½“Clipboard APIä¸å¯ç”¨æ—¶ï¼‰
        function fallbackCopyChart(originalChartId) {
            // 1. æ‰¾åˆ°åŸå§‹å›¾è¡¨
            const originalChart = activeCharts.find(c => c.id === originalChartId);
            if (!originalChart) {
                console.error('åŸå§‹å›¾è¡¨æœªæ‰¾åˆ°:', originalChartId);
                return;
            }

            // 2. æ£€æŸ¥chartsContainerå…ƒç´ æ˜¯å¦å­˜åœ¨
            const chartsContainer = document.getElementById('chartsContainer');
            if (!chartsContainer) {
                console.error('å›¾è¡¨å®¹å™¨æœªæ‰¾åˆ°');
                return;
            }

            // 3. åˆ›å»ºæ–°çš„å›¾è¡¨IDå’Œç¼–å·
            chartCounter++;
            const newChartId = `chart_${chartCounter}`;
            const newChartNumber = chartCounter;
            
            // 4. åˆ›å»ºæ–°çš„å›¾è¡¨å…ƒç´ 
            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart-container';
            chartDiv.id = newChartId;
            
            chartDiv.innerHTML = `
                <div class="chart-header">
                    <h4>å›¾${newChartNumber}: ${originalChart.columnName}</h4>
                    <div class="chart-actions">
                        <button onclick="copyChart('${newChartId}')" class="axis-button" style="margin-right: 10px; padding: 6px 12px; font-size: 13px; background: #9c27b0; color: white;">å¤åˆ¶å›¾è¡¨</button>
                        <button onclick="exportChartToPDF('${newChartId}')" class="axis-button" style="margin-right: 10px; padding: 6px 12px; font-size: 13px; background: #007bff; color: white;">å¯¼å‡ºPDF</button>
                        <button onclick="resetAllSettings('${newChartId}')" class="axis-button" style="margin-right: 10px; padding: 6px 12px; font-size: 13px; background: #dc3545; color: white;">å…¨å±€é‡ç½®</button>
                        <button onclick="showSelectColumnsDialog('${newChartId}')" class="axis-button" style="margin-right: 10px; padding: 6px 12px; font-size: 13px; background: #28a745; color: white;">é€‰æ‹©å¤šåˆ—</button>
                        <button onclick="showDataRangeDialog('${newChartId}')" class="axis-button" style="margin-right: 10px; padding: 6px 12px; font-size: 13px; background: #17a2b8; color: white;">æ•°æ®èŒƒå›´</button>
                        <button onclick="showAxisSettingsDialog('${newChartId}')" class="axis-button" style="margin-right: 10px; padding: 6px 12px; font-size: 13px; background: #ffc107; color: white;">åæ ‡è½´è®¾ç½®</button>
                        <button class="chart-close" onclick="removeChart('${newChartId}')">Ã—</button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas class="chart-canvas" id="${newChartId}_canvas"></canvas>
                </div>
            `;
            
            // 5. å°†æ–°å›¾è¡¨æ·»åŠ åˆ°å®¹å™¨
            chartsContainer.appendChild(chartDiv);
            
            // 6. æ·±æ‹·è´åŸå§‹å›¾è¡¨çš„çº¿æ¡é…ç½®
            const copiedLines = originalChart.lines.map(line => ({
                ...line
            }));
            
            // 7. åˆ›å»ºæ–°çš„å›¾è¡¨ä¿¡æ¯å¯¹è±¡
            const newChartInfo = {
                id: newChartId,
                columnName: originalChart.columnName,
                chartNumber: newChartNumber,
                startPoint: originalChart.startPoint,
                endPoint: originalChart.endPoint,
                xMin: originalChart.xMin,
                xMax: originalChart.xMax,
                y1Min: originalChart.y1Min,
                y1Max: originalChart.y1Max,
                y2Min: originalChart.y2Min,
                y2Max: originalChart.y2Max,
                axis: originalChart.axis,
                lines: copiedLines
            };
            
            // 8. å°†æ–°å›¾è¡¨æ·»åŠ åˆ°æ´»åŠ¨å›¾è¡¨åˆ—è¡¨
            activeCharts.push(newChartInfo);
            
            // 9. å»¶è¿Ÿç»˜åˆ¶å›¾è¡¨ï¼Œç¡®ä¿DOMå®Œå…¨æ¸²æŸ“
            setTimeout(() => {
                drawChartForColumn(originalChart.columnName, newChartId);
            }, 150);
        }
        
        // å¯¼å‡ºå›¾è¡¨ä¸ºPDFå‡½æ•°
        function exportChartToPDF(chartId) {
            // 1. æ‰¾åˆ°å›¾è¡¨å…ƒç´ 
            const chartElement = document.getElementById(chartId);
            if (!chartElement) {
                console.error('å›¾è¡¨å…ƒç´ æœªæ‰¾åˆ°:', chartId);
                return;
            }
            
            // 2. æ‰¾åˆ°Canvaså…ƒç´ 
            const canvasElement = document.getElementById(`${chartId}_canvas`);
            if (!canvasElement) {
                console.error('Canvaså…ƒç´ æœªæ‰¾åˆ°:', `${chartId}_canvas`);
                return;
            }
            
            // 3. è·å–å›¾è¡¨ä¿¡æ¯
            const chartInfo = activeCharts.find(c => c.id === chartId);
            if (!chartInfo) {
                console.error('å›¾è¡¨ä¿¡æ¯æœªæ‰¾åˆ°:', chartId);
                return;
            }
            
            try {
                // 4. å¼•å…¥jsPDFåº“
                const { jsPDF } = window.jspdf;
                
                // 5. åˆ›å»ºPDFæ–‡æ¡£
                const pdf = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });
                
                // 6. åˆ›å»ºé«˜åˆ†è¾¨ç‡Canvaså‰¯æœ¬
                const originalWidth = canvasElement.width;
                const originalHeight = canvasElement.height;
                const originalCtx = canvasElement.getContext('2d');
                
                // é«˜åˆ†è¾¨ç‡å€æ•° - æé«˜åˆ°3å€ä»¥è·å¾—æ›´é«˜æ¸…æ™°åº¦
                const scale = 3;
                
                // åˆ›å»ºä¸´æ—¶é«˜åˆ†è¾¨ç‡Canvas
                const highResCanvas = document.createElement('canvas');
                const highResCtx = highResCanvas.getContext('2d');
                
                // è®¾ç½®é«˜åˆ†è¾¨ç‡Canvaså¤§å°
                highResCanvas.width = originalWidth * scale;
                highResCanvas.height = originalHeight * scale;
                
                // è®¾ç½®å›¾åƒå¹³æ»‘å’ŒæŠ—é”¯é½¿
                highResCtx.imageSmoothingEnabled = true;
                highResCtx.imageSmoothingQuality = 'high';
                highResCtx.antialias = 'subpixel';
                
                // è®¾ç½®ç¼©æ”¾æ¯”ä¾‹
                highResCtx.scale(scale, scale);
                
                // ç»˜åˆ¶é«˜åˆ†è¾¨ç‡å›¾åƒ
                highResCtx.drawImage(canvasElement, 0, 0, originalWidth, originalHeight);
                
                // 7. å°†é«˜åˆ†è¾¨ç‡Canvasè½¬æ¢ä¸ºå›¾ç‰‡æ•°æ®URLï¼Œä½¿ç”¨æœ€é«˜è´¨é‡
                const canvasUrl = highResCanvas.toDataURL('image/png', 1.0);
                
                // 8. è·å–å›¾è¡¨æ ‡é¢˜
                const chartTitle = chartElement.querySelector('.chart-header h4').textContent;
                
                // 9. æ·»åŠ æ ‡é¢˜åˆ°PDFï¼ˆä½¿ç”¨å›¾ç‰‡æ–¹å¼å¤„ç†ä¸­æ–‡ï¼Œé¿å…å­—ä½“é—®é¢˜ï¼‰
                // åˆ›å»ºä¸´æ—¶Canvasç”¨äºç»˜åˆ¶ä¸­æ–‡æ ‡é¢˜
                const titleCanvas = document.createElement('canvas');
                const titleCtx = titleCanvas.getContext('2d');
                
                // è®¾ç½®æ ‡é¢˜Canvaså¤§å°
                const titleWidth = 800;
                const titleHeight = 80;
                titleCanvas.width = titleWidth;
                titleCanvas.height = titleHeight;
                
                // æ¸…ç©ºæ ‡é¢˜Canvas
                titleCtx.fillStyle = '#ffffff';
                titleCtx.fillRect(0, 0, titleWidth, titleHeight);
                
                // ç»˜åˆ¶ä¸­æ–‡æ ‡é¢˜ï¼ˆé«˜åˆ†è¾¨ç‡ï¼‰
                titleCtx.fillStyle = '#000000';
                titleCtx.font = '32px Arial, sans-serif';
                titleCtx.textAlign = 'center';
                titleCtx.textBaseline = 'middle';
                titleCtx.fillText(chartTitle, titleWidth / 2, titleHeight / 2);
                
                // å°†æ ‡é¢˜Canvasè½¬æ¢ä¸ºå›¾ç‰‡
                const titleUrl = titleCanvas.toDataURL('image/png');
                
                // 10. è®¡ç®—å›¾ç‰‡å¤§å°å’Œä½ç½®
                const pdfWidth = 270; // A4æ¨ªå‘å®½åº¦ï¼ˆmmï¼‰
                const pdfHeight = 190; // A4æ¨ªå‘é«˜åº¦ï¼ˆmmï¼‰
                const margin = 10;
                
                const imgWidth = pdfWidth - margin * 2;
                const imgHeight = pdfHeight - margin * 4; // ä¸ºæ ‡é¢˜å’Œé¡µè„šç•™å‡ºç©ºé—´
                
                const xPos = margin;
                let yPos = margin + 20; // æ ‡é¢˜ä¸‹æ–¹
                
                // 11. æ·»åŠ æ ‡é¢˜å›¾ç‰‡åˆ°PDFï¼ˆç¼©å°2å€ä»¥è·å¾—æ¸…æ™°æ•ˆæœï¼‰
                pdf.addImage(titleUrl, 'PNG', xPos, margin + 5, imgWidth, 15);
                
                // 12. æ·»åŠ å›¾è¡¨å›¾ç‰‡åˆ°PDFï¼ˆé«˜åˆ†è¾¨ç‡ï¼Œç¼©å°2å€ä»¥è·å¾—æ¸…æ™°æ•ˆæœï¼‰
                pdf.addImage(canvasUrl, 'PNG', xPos, yPos, imgWidth, imgHeight, undefined, 'FAST');
                
                // 13. å¤„ç†é¡µè„šä¿¡æ¯ï¼ˆä½¿ç”¨å›¾ç‰‡æ–¹å¼ï¼‰
                const footerCanvas = document.createElement('canvas');
                const footerCtx = footerCanvas.getContext('2d');
                
                // è®¾ç½®é¡µè„šCanvaså¤§å°ï¼ˆé«˜åˆ†è¾¨ç‡ï¼‰
                const footerWidth = 1000;
                const footerHeight = 40;
                footerCanvas.width = footerWidth;
                footerCanvas.height = footerHeight;
                
                // æ¸…ç©ºé¡µè„šCanvas
                footerCtx.fillStyle = '#ffffff';
                footerCtx.fillRect(0, 0, footerWidth, footerHeight);
                
                // ç»˜åˆ¶é¡µè„šä¿¡æ¯ï¼ˆé«˜åˆ†è¾¨ç‡ï¼‰
                footerCtx.fillStyle = '#666666';
                footerCtx.font = '20px Arial, sans-serif';
                footerCtx.textAlign = 'left';
                footerCtx.textBaseline = 'top';
                footerCtx.fillText(`å¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString()}`, 0, 10);
                
                footerCtx.textAlign = 'right';
                footerCtx.fillText(`é¡µ 1 / 1`, footerWidth, 10);
                
                // å°†é¡µè„šCanvasè½¬æ¢ä¸ºå›¾ç‰‡
                const footerUrl = footerCanvas.toDataURL('image/png');
                
                // æ·»åŠ é¡µè„šå›¾ç‰‡åˆ°PDFï¼ˆç¼©å°2å€ä»¥è·å¾—æ¸…æ™°æ•ˆæœï¼‰
                pdf.addImage(footerUrl, 'PNG', xPos, pdfHeight - margin - 10, imgWidth, 10);
                
                // 14. ç”Ÿæˆæ–‡ä»¶å
                const fileName = `${chartInfo.columnName}_å›¾è¡¨_${new Date().getTime()}.pdf`;
                
                // 15. ä¸‹è½½PDF
                pdf.save(fileName);
            } catch (error) {
                console.error('å¯¼å‡ºPDFå¤±è´¥:', error);
                alert('å¯¼å‡ºPDFå¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯ã€‚');
            }
        }
        
        // é‡ç½®æ•°æ®èŒƒå›´
        function resetDataRange(chartId) {
            const chartInfo = activeCharts.find(c => c.id === chartId);
            if (!chartInfo) return;
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            const startPointInput = document.getElementById(chartId + '_startPoint');
            const endPointInput = document.getElementById(chartId + '_endPoint');
            if (startPointInput) startPointInput.value = '';
            if (endPointInput) endPointInput.value = '';
            
            // é‡ç½®å›¾è¡¨ä¿¡æ¯
            chartInfo.startPoint = null;
            chartInfo.endPoint = null;
            
            // é‡æ–°ç»˜åˆ¶å›¾è¡¨
            drawChartForColumn(chartInfo.columnName, chartId);
        }
        
        // é‡ç½®åæ ‡è½´è®¾ç½®
        function resetAxis(chartId, axis) {
            const chartInfo = activeCharts.find(c => c.id === chartId);
            if (!chartInfo) return;
            
            // é‡ç½®Xè½´
            if (axis === 'x') {
                const xMinInput = document.getElementById(chartId + '_xMin');
                const xMaxInput = document.getElementById(chartId + '_xMax');
                if (xMinInput) xMinInput.value = '';
                if (xMaxInput) xMaxInput.value = '';
                chartInfo.xMin = null;
                chartInfo.xMax = null;
            } 
            // é‡ç½®ä¸»Yè½´
            else if (axis === 'y1') {
                const yMinInput = document.getElementById(chartId + '_y1Min');
                const yMaxInput = document.getElementById(chartId + '_y1Max');
                if (yMinInput) yMinInput.value = '';
                if (yMaxInput) yMaxInput.value = '';
                chartInfo.y1Min = null;
                chartInfo.y1Max = null;
            }
            // é‡ç½®æ¬¡Yè½´
            else if (axis === 'y2') {
                const yMinInput = document.getElementById(chartId + '_y2Min');
                const yMaxInput = document.getElementById(chartId + '_y2Max');
                if (yMinInput) yMinInput.value = '';
                if (yMaxInput) yMaxInput.value = '';
                chartInfo.y2Min = null;
                chartInfo.y2Max = null;
            }
            
            // é‡æ–°ç»˜åˆ¶å›¾è¡¨
            drawChartForColumn(chartInfo.columnName, chartId);
        }

        // ç§»é™¤å›¾è¡¨
        function removeChart(chartId) {
            const chartElement = document.getElementById(chartId);
            if (chartElement) {
                chartElement.remove();
                activeCharts = activeCharts.filter(chart => chart.id !== chartId);
            }
        }

        // æ˜¾ç¤ºæ•°æ®åˆ†æ
        function displayAnalysis(columnName) {
            const contentBody = document.getElementById('contentBody');
            
            if (!parsedData || parsedData.length === 0) {
                contentBody.innerHTML = '<div class="error">æ²¡æœ‰æ•°æ®å¯åˆ†æ</div>';
                return;
            }

            // è·å–è¯¥åˆ—çš„æ•°æ®
            const values = parsedData
                .map(row => row[columnName])
                .filter(v => v !== null && v !== undefined && !isNaN(v) && typeof v === 'number');

            if (values.length === 0) {
                contentBody.innerHTML = '<div class="error">è¯¥åˆ—æ²¡æœ‰æœ‰æ•ˆçš„æ•°å€¼æ•°æ®</div>';
                return;
            }

            // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
            const sorted = [...values].sort((a, b) => a - b);
            const sum = values.reduce((a, b) => a + b, 0);
            const mean = sum / values.length;
            const variance = values.reduce((acc, v) => acc + Math.pow(v - mean, 2), 0) / values.length;
            const std = Math.sqrt(variance);
            const min = sorted[0];
            const max = sorted[sorted.length - 1];
            const median = sorted[Math.floor(sorted.length / 2)];
            const q25 = sorted[Math.floor(sorted.length * 0.25)];
            const q75 = sorted[Math.floor(sorted.length * 0.75)];

            // ç”ŸæˆHTML
            let html = `
                <div class="analysis-section">
                    <h3>ğŸ“Š åŸºæœ¬ç»Ÿè®¡ä¿¡æ¯</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="label">æ•°æ®ç‚¹æ•°</div>
                            <div class="value">${values.length.toLocaleString()}</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">å¹³å‡å€¼</div>
                            <div class="value">${mean.toFixed(2)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">æ ‡å‡†å·®</div>
                            <div class="value">${std.toFixed(2)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">æœ€å°å€¼</div>
                            <div class="value">${min.toFixed(2)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">æœ€å¤§å€¼</div>
                            <div class="value">${max.toFixed(2)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">ä¸­ä½æ•°</div>
                            <div class="value">${median.toFixed(2)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">25%åˆ†ä½æ•°</div>
                            <div class="value">${q25.toFixed(2)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">75%åˆ†ä½æ•°</div>
                            <div class="value">${q75.toFixed(2)}</div>
                        </div>
                    </div>
                </div>

                <div class="chart-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>ğŸ“ˆ æŠ˜çº¿å›¾</h3>
                        <button onclick="addNewChart()" style="padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9em;">
                            + æ·»åŠ å›¾è¡¨
                        </button>
                    </div>
                    <div class="charts-container" id="chartsContainer">
                        <!-- å›¾è¡¨å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                    </div>
                </div>
            `;

            contentBody.innerHTML = html;

            // ç­‰å¾…DOMæ›´æ–°å®Œæˆåå†æ“ä½œ
            setTimeout(() => {
                // æ¸…ç©ºä¹‹å‰çš„å›¾è¡¨
                const chartsContainer = document.getElementById('chartsContainer');
                if (chartsContainer) {
                    chartsContainer.innerHTML = '';
                }
                activeCharts = [];
                chartCounter = 0;

                // æ·»åŠ ç¬¬ä¸€ä¸ªå›¾è¡¨
                addChart(columnName);
            }, 50);
        }

        // ä¸ºæŒ‡å®šåˆ—ç»˜åˆ¶å›¾è¡¨
        function drawChartForColumn(columnName, chartId) {
            if (!parsedData || parsedData.length === 0) {
                console.warn('æ²¡æœ‰æ•°æ®å¯ç»˜åˆ¶');
                return;
            }

            const canvas = document.getElementById(chartId + '_canvas');
            if (!canvas) {
                console.error('Canvaså…ƒç´ æœªæ‰¾åˆ°:', chartId + '_canvas');
                return;
            }

            // è·å–å›¾è¡¨ä¿¡æ¯
            const chartInfo = activeCharts.find(c => c.id === chartId);
            
            // ç»˜åˆ¶æŠ˜çº¿å›¾ï¼ˆæ”¯æŒå¤šæ¡çº¿ï¼‰
            drawLineChart(columnName, canvas, chartInfo);
        }

        // ç»˜åˆ¶æŠ˜çº¿å›¾ï¼ˆæ”¯æŒå¤šæ¡çº¿ï¼‰
        function drawLineChart(columnName, canvasElement, chartInfo) {
            if (!canvasElement) return;

            // è·å–å®¹å™¨å°ºå¯¸å¹¶è®¾ç½®Canvasåˆ†è¾¨ç‡ï¼ˆè§£å†³æ¨¡ç³Šé—®é¢˜ï¼‰
            const container = canvasElement.parentElement;
            const containerWidth = container.clientWidth;
            const containerHeight = 500;
            
            // è®¾ç½®Canvaså®é™…å°ºå¯¸ï¼ˆé«˜åˆ†è¾¨ç‡ï¼‰
            const devicePixelRatio = window.devicePixelRatio || 1;
            canvasElement.width = containerWidth * devicePixelRatio;
            canvasElement.height = containerHeight * devicePixelRatio;
            canvasElement.style.width = containerWidth + 'px';
            canvasElement.style.height = containerHeight + 'px';

            const ctx = canvasElement.getContext('2d');
            ctx.scale(devicePixelRatio, devicePixelRatio);

            const width = containerWidth;
            const height = containerHeight;
            // å¢åŠ å³ä¾§è¾¹è·ï¼Œä¸ºæ¬¡Yè½´ç•™å‡ºç©ºé—´
            const margin = { top: 50, right: 100, bottom: 80, left: 100 };

            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, width, height);

            // è·å–æ‰€æœ‰å¯è§çº¿æ¡çš„æ•°æ®
            const visibleLines = chartInfo.lines.filter(line => line.visible);
            if (visibleLines.length === 0) {
                // å¦‚æœæ²¡æœ‰å¯è§çº¿æ¡ï¼Œæ˜¾ç¤ºæç¤º
                ctx.fillStyle = '#999';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('æ²¡æœ‰å¯è§çš„æ•°æ®çº¿', width / 2, height / 2);
                return;
            }

            // å‡†å¤‡æ‰€æœ‰æ•°æ®ï¼Œç”¨äºè®¡ç®—åæ ‡è½´èŒƒå›´
            const lineData = {};
            
            // ä¸ºæ¯ä¸ªYè½´åˆ†åˆ«æ”¶é›†æ•°æ®
            const y1Values = [];
            const y2Values = [];
            
            // æ”¶é›†æ‰€æœ‰å¯è§çº¿æ¡çš„æ•°æ®
            visibleLines.forEach(line => {
                const values = parsedData
                    .map(row => row[line.columnName])
                    .filter(v => v !== null && v !== undefined && !isNaN(v) && typeof v === 'number');
                
                lineData[line.columnName] = values;
                
                // æ ¹æ®çº¿æ¡ä½¿ç”¨çš„Yè½´ï¼Œå°†å€¼æ·»åŠ åˆ°å¯¹åº”çš„æ•°ç»„ä¸­
                if (line.axis === 'y1') {
                    y1Values.push(...values);
                } else {
                    y2Values.push(...values);
                }
            });

            // è®¡ç®—æ¯ä¸ªYè½´çš„æ•°æ®èŒƒå›´ï¼ˆè€ƒè™‘è‡ªå®šä¹‰èŒƒå›´ï¼‰
            let minValueY1 = y1Values.length > 0 ? Math.min(...y1Values) : 0;
            let maxValueY1 = y1Values.length > 0 ? Math.max(...y1Values) : 100;
            let minValueY2 = y2Values.length > 0 ? Math.min(...y2Values) : 0;
            let maxValueY2 = y2Values.length > 0 ? Math.max(...y2Values) : 100;
            
            // å¦‚æœåªæœ‰ä¸€ä¸ªYè½´ï¼Œä½¿ç”¨è¯¥Yè½´çš„æ•°æ®èŒƒå›´
            let minValue = y1Values.length > 0 ? minValueY1 : minValueY2;
            let maxValue = y1Values.length > 0 ? maxValueY1 : maxValueY2;
            
            // è®¡ç®—æ•°æ®ç‚¹èŒƒå›´ï¼ˆè€ƒè™‘è‡ªå®šä¹‰èŒƒå›´ï¼‰
            let dataStart = 0;
            let dataEnd = Math.max(...Object.values(lineData).map(data => data.length - 1));
            
            // åº”ç”¨æ•°æ®ç‚¹èŒƒå›´è¿‡æ»¤
            if (chartInfo) {
                if (chartInfo.startPoint !== null) {
                    dataStart = Math.max(0, chartInfo.startPoint - 1);
                }
                if (chartInfo.endPoint !== null) {
                    dataEnd = Math.min(dataEnd, chartInfo.endPoint - 1);
                }
            }
            
            // è®¡ç®—Xè½´èŒƒå›´ï¼ˆè€ƒè™‘è‡ªå®šä¹‰èŒƒå›´ï¼‰
            let xMin = dataStart;
            let xMax = dataEnd;
            
            if (chartInfo) {
                if (chartInfo.xMin !== null) xMin = Math.max(xMin, Math.min(chartInfo.xMin - 1, xMax));
                if (chartInfo.xMax !== null) xMax = Math.min(xMax, Math.max(chartInfo.xMax - 1, xMin));
                if (chartInfo.xMin !== null && chartInfo.xMax !== null) {
                    xMin = Math.max(dataStart, chartInfo.xMin - 1);
                    xMax = Math.min(dataEnd, chartInfo.xMax - 1);
                }
            }
            
            // è¿‡æ»¤æ•°æ®ï¼ˆæ ¹æ®Xè½´èŒƒå›´ï¼‰
            Object.keys(lineData).forEach(column => {
                lineData[column] = lineData[column].slice(xMin, xMax + 1);
            });

            // ç¼©æ”¾å‡½æ•°
            // Xè½´ï¼šç´¢å¼•ä»0å¼€å§‹ï¼Œå¯¹åº”æ•°ç»„ç´¢å¼•
            const xScale = (index) => {
                const maxLength = Math.max(...Object.values(lineData).map(data => data.length - 1));
                if (maxLength <= 1) return margin.left;
                return margin.left + (index / maxLength) * (width - margin.left - margin.right);
            };
            
            // Yè½´ï¼šæ•°å€¼æ˜ å°„ï¼ˆä¸»Yè½´ï¼‰
            const yScaleY1 = (value) => {
                // ä½¿ç”¨ä¸»Yè½´èŒƒå›´
                let y1Min = minValueY1;
                let y1Max = maxValueY1;
                if (chartInfo && chartInfo.y1Min !== null && chartInfo.y1Max !== null) {
                    y1Min = chartInfo.y1Min;
                    y1Max = chartInfo.y1Max;
                }
                const y1Range = y1Max - y1Min;
                const y1Padding = y1Range < 0.1 ? y1Range * 0.2 : (y1Range > 100 ? y1Range * 0.05 : y1Range * 0.1);
                const range = y1Range + y1Padding * 2;
                if (range === 0) return margin.top + (height - margin.top - margin.bottom) / 2;
                return margin.top + (height - margin.top - margin.bottom) - ((value - y1Min + y1Padding) / range) * (height - margin.top - margin.bottom);
            };
            
            // Yè½´ï¼šæ•°å€¼æ˜ å°„ï¼ˆæ¬¡Yè½´ï¼‰
            const yScaleY2 = (value) => {
                // ä½¿ç”¨æ¬¡Yè½´èŒƒå›´
                let y2Min = minValueY2;
                let y2Max = maxValueY2;
                if (chartInfo && chartInfo.y2Min !== null && chartInfo.y2Max !== null) {
                    y2Min = chartInfo.y2Min;
                    y2Max = chartInfo.y2Max;
                }
                const y2Range = y2Max - y2Min;
                const y2Padding = y2Range < 0.1 ? y2Range * 0.2 : (y2Range > 100 ? y2Range * 0.05 : y2Range * 0.1);
                const range = y2Range + y2Padding * 2;
                if (range === 0) return margin.top + (height - margin.top - margin.bottom) / 2;
                return margin.top + (height - margin.top - margin.bottom) - ((value - y2Min + y2Padding) / range) * (height - margin.top - margin.bottom);
            };

            // ç»˜åˆ¶èƒŒæ™¯
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(margin.left, margin.top, width - margin.left - margin.right, height - margin.top - margin.bottom);

            // ç»˜åˆ¶ç½‘æ ¼
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 10; i++) {
                const y = margin.top + ((height - margin.top - margin.bottom) / 10) * i;
                ctx.beginPath();
                ctx.moveTo(margin.left, y);
                ctx.lineTo(width - margin.right, y);
                ctx.stroke();
            }

            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºæ¬¡Yè½´
            const hasMultipleYAxes = visibleLines.some(line => line.axis === 'y2');
            
            // ç»˜åˆ¶åæ ‡è½´
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(margin.left, margin.top);
            ctx.lineTo(margin.left, height - margin.bottom);
            ctx.lineTo(width - margin.right, height - margin.bottom);
            ctx.stroke();
            
            // å¦‚æœæœ‰æ¬¡Yè½´ï¼Œç»˜åˆ¶æ¬¡Yè½´
            if (hasMultipleYAxes) {
                ctx.beginPath();
                ctx.moveTo(width - margin.right, margin.top);
                ctx.lineTo(width - margin.right, height - margin.bottom);
                ctx.stroke();
            }

            // ç»˜åˆ¶Xè½´åˆ»åº¦å’Œæ ‡ç­¾
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            
            const xTickCount = 10;
            const maxLength = Math.max(...Object.values(lineData).map(data => data.length - 1));
            
            for (let i = 0; i <= xTickCount; i++) {
                const x = margin.left + (i / xTickCount) * (width - margin.left - margin.right);
                // Xè½´æ˜¾ç¤ºå®é™…çš„æ•°æ®ç‚¹ç´¢å¼•ï¼ˆä»1å¼€å§‹ï¼Œå¯¹åº”åŸå§‹æ•°æ®è¡Œå·ï¼‰
                const relativeIndex = Math.round((i / xTickCount) * maxLength);
                const value = xMin + relativeIndex + 1;
                
                // ç»˜åˆ¶åˆ»åº¦çº¿
                ctx.strokeStyle = '#999';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x, height - margin.bottom);
                ctx.lineTo(x, height - margin.bottom + 5);
                ctx.stroke();
                
                // ç»˜åˆ¶æ ‡ç­¾ï¼ˆæ ¼å¼åŒ–å¤§æ•°å­—ï¼‰
                const label = value >= 1000 ? (value / 1000).toFixed(1) + 'k' : value.toString();
                ctx.fillText(label, x, height - margin.bottom + 8);
            }
            
            // Xè½´æ ‡é¢˜
            ctx.fillStyle = '#333';
            ctx.font = 'bold 14px Arial';
            ctx.fillText('æ•°æ®ç‚¹ç´¢å¼•', margin.left + (width - margin.left - margin.right) / 2, height - 20);

            // ç»˜åˆ¶Yè½´åˆ»åº¦å’Œæ ‡ç­¾ï¼ˆä¸»Yè½´ï¼‰
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            
            const yTickCount = 10;
            let y1Min = minValueY1;
            let y1Max = maxValueY1;
            if (chartInfo && chartInfo.y1Min !== null && chartInfo.y1Max !== null) {
                y1Min = chartInfo.y1Min;
                y1Max = chartInfo.y1Max;
            }
            const y1Range = y1Max - y1Min;
            const y1Padding = y1Range < 0.1 ? y1Range * 0.2 : (y1Range > 100 ? y1Range * 0.05 : y1Range * 0.1);
            
            for (let i = 0; i <= yTickCount; i++) {
                const y = margin.top + (i / yTickCount) * (height - margin.top - margin.bottom);
                // Yè½´ä»æœ€å¤§å€¼åˆ°æœ€å°å€¼
                const value = y1Max + y1Padding - (i / yTickCount) * (y1Range + y1Padding * 2);
                
                // ç»˜åˆ¶åˆ»åº¦çº¿
                ctx.strokeStyle = '#999';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(margin.left, y);
                ctx.lineTo(margin.left - 5, y);
                ctx.stroke();
                
                // ç»˜åˆ¶æ ‡ç­¾ï¼ˆæ ¹æ®æ•°å€¼èŒƒå›´å†³å®šå°æ•°ä½æ•°ï¼‰
                let label;
                if (Math.abs(value) < 0.01) {
                    label = value.toFixed(4);
                } else if (Math.abs(value) < 1) {
                    label = value.toFixed(3);
                } else if (Math.abs(value) < 100) {
                    label = value.toFixed(2);
                } else {
                    label = value.toFixed(1);
                }
                ctx.fillText(label, margin.left - 10, y);
            }
            
            // Yè½´æ ‡é¢˜
            ctx.save();
            ctx.translate(15, margin.top + (height - margin.top - margin.bottom) / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillStyle = '#333';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('ä¸»Yè½´æ•°å€¼', 0, 0);
            ctx.restore();
            
            // ç»˜åˆ¶æ¬¡Yè½´åˆ»åº¦å’Œæ ‡ç­¾ï¼ˆå¦‚æœæœ‰æ¬¡Yè½´ï¼‰
            if (hasMultipleYAxes) {
                ctx.fillStyle = '#666';
                ctx.font = '12px Arial';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';
                
                const yTickCount = 10;
                let y2Min = minValueY2;
                let y2Max = maxValueY2;
                if (chartInfo && chartInfo.y2Min !== null && chartInfo.y2Max !== null) {
                    y2Min = chartInfo.y2Min;
                    y2Max = chartInfo.y2Max;
                }
                const y2Range = y2Max - y2Min;
                const y2Padding = y2Range < 0.1 ? y2Range * 0.2 : (y2Range > 100 ? y2Range * 0.05 : y2Range * 0.1);
                
                for (let i = 0; i <= yTickCount; i++) {
                    const y = margin.top + ((height - margin.top - margin.bottom) / 10) * i;
                    // æ¬¡Yè½´ä»æœ€å¤§å€¼åˆ°æœ€å°å€¼
                    const value = y2Max + y2Padding - (i / yTickCount) * (y2Range + y2Padding * 2);
                    
                    // ç»˜åˆ¶åˆ»åº¦çº¿
                    ctx.strokeStyle = '#999';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(width - margin.right, y);
                    ctx.lineTo(width - margin.right + 5, y);
                    ctx.stroke();
                    
                    // ç»˜åˆ¶æ ‡ç­¾ï¼ˆæ ¹æ®æ•°å€¼èŒƒå›´å†³å®šå°æ•°ä½æ•°ï¼‰
                    let label;
                    if (Math.abs(value) < 0.01) {
                        label = value.toFixed(4);
                    } else if (Math.abs(value) < 1) {
                        label = value.toFixed(3);
                    } else if (Math.abs(value) < 100) {
                        label = value.toFixed(2);
                    } else {
                        label = value.toFixed(1);
                    }
                    ctx.fillText(label, width - margin.right + 10, y);
                }
                
                // æ¬¡Yè½´æ ‡é¢˜
                ctx.save();
                ctx.translate(width - 15, margin.top + (height - margin.top - margin.bottom) / 2);
                ctx.rotate(Math.PI / 2);
                ctx.fillStyle = '#333';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('æ¬¡Yè½´æ•°å€¼', 0, 0);
                ctx.restore();
            }

            // ç»˜åˆ¶æ‰€æœ‰å¯è§çš„æ•°æ®çº¿
            visibleLines.forEach(line => {
                const values = lineData[line.columnName];
                if (!values || values.length === 0) return;

                // é€‰æ‹©å¯¹åº”çš„Yè½´ç¼©æ”¾å‡½æ•°
                const yScale = line.axis === 'y1' ? yScaleY1 : yScaleY2;

                // ç»˜åˆ¶æŠ˜çº¿
                ctx.strokeStyle = line.color;
                ctx.lineWidth = 2.5;
                ctx.lineJoin = 'round';
                ctx.lineCap = 'round';
                ctx.beginPath();

                // å¦‚æœæ•°æ®ç‚¹å¤ªå¤šï¼Œåªç»˜åˆ¶å…³é”®ç‚¹ä»¥æé«˜æ€§èƒ½
                const drawEveryN = values.length > 10000 ? Math.ceil(values.length / 5000) : 1;
                
                values.forEach((value, index) => {
                    if (index % drawEveryN === 0 || index === values.length - 1) {
                        const x = xScale(index);
                        const y = yScale(value);
                        
                        if (index === 0 || (index % drawEveryN === 0 && index > 0)) {
                            ctx.lineTo(x, y);
                        } else {
                            ctx.moveTo(x, y);
                        }
                    }
                });

                ctx.stroke();

                // å¦‚æœæ•°æ®ç‚¹ä¸å¤ªå¤šï¼Œç»˜åˆ¶æ•°æ®ç‚¹
                if (values.length <= 500) {
                    ctx.fillStyle = line.color;
                    values.forEach((value, index) => {
                        if (index % Math.max(1, Math.floor(values.length / 100)) === 0) {
                            const x = xScale(index);
                            const y = yScale(value);
                            ctx.beginPath();
                            ctx.arc(x, y, 2.5, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    });
                }
            });

            // ç»˜åˆ¶å›¾ä¾‹
            drawLegend(ctx, visibleLines, margin.left, margin.top - 40, width - margin.left - margin.right);

            // ç»˜åˆ¶æ ‡é¢˜
            ctx.fillStyle = '#667eea';
            ctx.font = 'bold 18px Arial';
            ctx.textAlign = 'center';
            // å–æ¶ˆæ˜¾ç¤º"æ•°æ®å¯¹æ¯”"æ–‡å­—
            // ctx.fillText('æ•°æ®å¯¹æ¯”', margin.left + (width - margin.left - margin.right) / 2, 25);
        }

        // ç»˜åˆ¶å›¾ä¾‹
        function drawLegend(ctx, lines, x, y, width) {
            const legendItemHeight = 20;
            const legendItemMargin = 15;
            
            let currentX = x;
            let currentY = y;
            
            lines.forEach((line, index) => {
                const itemWidth = ctx.measureText(line.columnName).width + 25;
                
                // å¦‚æœè¶…è¿‡å®½åº¦ï¼Œæ¢è¡Œ
                if (currentX + itemWidth > x + width - 10) {
                    currentX = x;
                    currentY += legendItemHeight + 5;
                }
                
                // ç»˜åˆ¶é¢œè‰²æ–¹å—
                ctx.fillStyle = line.color;
                ctx.fillRect(currentX, currentY + 3, 15, 15);
                
                // ç»˜åˆ¶æ–‡å­—
                ctx.fillStyle = '#555';
                ctx.font = '14px Arial';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';
                ctx.fillText(line.columnName, currentX + 20, currentY + 10.5);
                
                currentX += itemWidth + legendItemMargin;
            });
        }

        // é¡µé¢åŠ è½½æ—¶å°è¯•è‡ªåŠ¨åŠ è½½æ–‡ä»¶
        window.addEventListener('load', () => {
            // å¯ä»¥åœ¨è¿™é‡Œè®¾ç½®é»˜è®¤æ–‡ä»¶
            // loadFile();
        });
    </script>
</body>
</html>
